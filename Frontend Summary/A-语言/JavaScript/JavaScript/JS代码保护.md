# JS代码保护

### **为什么要保护JS代码**

- JavaScript代码运行于客户端
- JavaScript代码是公开透明的

由于这两个原因，致使JavaScript代码是不安全的，任何人都可以读、分析、复制、盗用甚至篡改。

### **应用场景**

以下场景就通过特定的防护措施提高了攻击成本：

- 某些网站会在页面中使用JavaScript对数据进行加密，以保护数据的安全性和隐私性，在爬取时需要通过解密JavaScript代码才能获取到数据。
- 某些网站的URL会有某个参数带有一些看不太懂的长串加密参数，攻击者要爬取的话就必须要知道这些参数是怎么构造的，否则无法正确地访问该URL。
- 翻看网站的JavaScript源代码，可以发现很多压缩了或者看不太懂的字符，比如JavaScript文件名被编码，JavaScript的文件内容都压缩成几行，JavaScript变量也被修改成单个字符或者一些十六进制的字符，所以我们不能轻易地根据JavaScript找出某些接口的加密逻辑。

### 涉及的技术

这些场景都是网站为了保护数据不被轻易抓取采取的措施，运用的技术主要有：

- 接口加密技术
- JavaScript压缩、混淆和加密技术

## 技术原理

### 接口加密技术

数据和功能一般是通过服务器提供的接口来实现，为了提升接口的安全性，客户端会和服务端约定一种接口检验方式，通常是各种加密和编码算法，如Base64、Hex、MD5、AES、DES、RSA等。

常用的数据接口都会携带一个sign参数用于权限管控：

① 客户端和服务端约定一种接口校验逻辑，客户端在每次请求服务端接口的时候附带一个sign参数。
② sign参数的逻辑自定义，可以由当前时间戳信息、设备ID、日期、双方约定好的秘钥经过一些加密算法构造而成。
③ 客户端根据约定的加密算法构造sign，每次请求服务器的时候附带上sign数。
④ 服务端根据约定的加密算法和请求的数据对sign进行校验，如果检验通过，才返回数据，否则拒绝响应。

![1713003314625](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1713003314625.png)

这就是一个比较简单的接口参数加密的实现，如果有人想要调用这个接口的话，必须要破解sign的生成逻辑，否则是无法正常调用接口的。

当然上面的实现思路比较简单，还可以增加一些时间戳信息和访问频次来增加时效性判断，或使用非对称加密提高加密的复杂程度。

实现接口参数加密需要用到一些加密算法，客户端和服务器都有对应的SDK来实现这些加密算法，如JavaScript的crypto-js、Python的hashlib、Crypto等等。如果是网页且客户端的加密逻辑是用JavaScript来实现的话，其源代码对用户是完全可见的，所以我们需要用压缩、混淆、加密的方式来对JavaScript代码进行一定程度的保护。

### 什么是压缩

去除JavaScript代码中不必要的空格、换行等内容，使源码都压缩为几行内容，降低代码可读性，同时可提高网站的加载速度。

如果仅仅是去除空格换行这样的压缩方式，几乎没有任何防护作用，这种压缩方式仅仅是降低了代码的直接可读性，可以用IDE、在线工具或Chrome轻松将JavaScript代码变得易读。

所以JavaScript压缩技术只能在很小的程度上起到防护作用，想提高防护的效果还得依靠JavaScript混淆和加密技术。

### 什么是混淆

使用变量混淆、字符串混淆、属性加密、控制流平坦化、调试保护、多态变异等手段，使代码变得难以阅读和分析，同时不影响代码原有功能，是一种理想且实用的JS保护方案。

- **变量混淆**：将变量名、方法名、常量名随机变为无意义的乱码字符串，降低代码可读性，如转成单个字符或十六进制字符串。
- **字符串混淆**：将字符串阵列化集中放置，并进行MD5或Base64编码存储，使代码中不出现明文字符串，可以避免使用全局搜索字符串的方式定位到入口点。
- **属性加密**：针对JavaScript对象的属性进行加密转化，隐藏代码之间的调用关系，把key-value的映射关系混淆掉。
- **控制流平坦化**：打乱函数原有代码执行流程及函数调用关系，使代码逻辑变得混乱无序。
- **调试保护**：基于调试器特性，加入一些强制调试debug语句，无限debug、定时debug、debug关键字，使其在调试模式下难以顺利执行JavaScript代码。
- **多态变异**：JavaScript代码每次被调用时，代码自身立刻自动发生变异，变化为与之前完全不同的代码，避免代码被动态分析调试。

### 什么是加密

JavaScript加密是对JavaScript混淆技术防护的进一步升级，基本思路是将一些核心逻辑用C/C++语言来编写，并通过JavaScript调用执行，从而起到二进制级别的防护作用，加密的方式主要有Emscripten和WebAssembly等。

**1. Emscripten**

Emscripten编译器可以将C/C++代码编译成asm.js的JavaScript变体，再由JavaScript调用执行，因此某些JavaScript的核心功能可以使用C/C++语言实现。

**2.WebAssembly**

WebAssembly也能将C/C++代码转成JavaScript引擎可以运行的代码，但转出来的代码是二进制字节码，而asm.js是文本，因此运行速度更快、体积更小，得到的字节码具有和JavaScript相同的功能，在语法上完全脱离JavaScript，同时具有沙盒化的执行环境，利用WebAssembly技术，可以将一些核心的功能用C/C++语言实现，形成浏览器字节码的形式，然后在JavaScript中通过类似如下的方式调用：

![1713003391908](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1713003391908.png)

这种加密方式更加安全，想要逆向或破解需要逆向WebAssembly，难度极大。

## 工具介绍

### **压缩混淆工具**

- **Uglifyjs**（开源）：

  用NodeJS编写的JavaScript压缩工具，是目前最流行的JS压缩工具，JQuery就是使用此工具压缩，UglifyJS压缩率高，压缩选项多，并且具有优化代码，格式化代码功能。

- **jshaman**：

  jshaman是一个商业级工具，看了很多社区的评论，这个目前是最好的，可以在线免费使用，也可以购买商业版。

- **jsfuck**：

  开源的js混淆工具，原理比较简单，通过特定的字符串加上下标定位字符，再由这些字符替换源代码，从而实现混淆。

- **YUI Compressor：**

  业界巨头yahoo提供的一个前端压缩工具，通过java库编译css或js文件进行压缩

### **反混淆工具**

- **jsbeautifier**：

  jsbeautifier是一个为前端开发人员制作的Chrome扩展，能够直接查看经过压缩的Javascript代码。

- **UnuglifyJS**：

  压缩工具uglify对应的解混淆工具。

- **jspacker**：

  用PHP编写的压缩工具，可以混淆代码保护知识产权，产生的代码兼容IE、FireFox等常用浏览器，国内大部分在线工具网站都采用这种算法压缩。

