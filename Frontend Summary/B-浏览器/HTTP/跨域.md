# è·¨åŸŸ

> ![1712990011900](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1712990011900.png)
>
> è¿™ä¸ªé”™è¯¯å°±æ˜¯ä¸€ä¸ª **è·¨åŸŸ** çš„é—®é¢˜ï¼Œæƒ³è¦è§£å†³å®ƒéå¸¸ç®€å•ï¼š
>
> - åœ¨å‰ç«¯ï¼šå¯ä»¥å†™å…¥ devServer çš„ proxy ä»£ç†ï¼ˆæˆ–è€…é€šè¿‡ nginx ä»£ç†ï¼‰
> - åœ¨åç«¯ï¼šå¯ä»¥é€šè¿‡ cors æ·»åŠ å“åº”å¤´

## å­˜åœ¨è·¨åŸŸé—®é¢˜çš„åŸå› 

æˆ‘ä»¬æƒ³è±¡ä¸€ä¸ªåœºæ™¯ï¼Œä½†æ˜¯**æ³¨æ„ï¼šå› ä¸º cookie å­˜åœ¨è·¨åŸŸï¼Œæ‰€ä»¥ä»¥ä¸‹æƒ…å†µä¸ä¼šå­˜åœ¨ï¼Œå¤§å®¶ä¹Ÿæ— éœ€æ‹…å¿ƒã€‚** 

> æˆ‘ä»¬æ­¤æ—¶çš„å‡è®¾ï¼Œæ˜¯åœ¨è®¨è®ºå¦‚æœæ²¡æœ‰è·¨åŸŸä¼šæ€ä¹ˆæ ·ï¼š
>
> 1. ç°åœ¨ä½ æƒ³è¦ç™»å½•ä¸€ä¸ªé“¶è¡Œç½‘ç«™ï¼šbank.comã€‚
> 2. ç™»å½•åï¼Œâ€œcookieï¼ˆå½“ç„¶ä¹Ÿæœ‰å¯èƒ½æ˜¯ tokenï¼‰â€å°†å­˜å‚¨åœ¨ä½ çš„æµè§ˆå™¨ä¸­ã€‚ è¿™è¡¨ç¤ºå‘Šè¯‰æœåŠ¡å™¨ä½ çš„æµè§ˆå™¨ç°åœ¨å·²ç™»å½•åˆ°å¸æˆ·ï¼‰ã€‚
> 3. ç°åœ¨ï¼Œæ‰€æœ‰æœªæ¥çš„è¯·æ±‚éƒ½å°†åŒ…å«æ­¤ cookieï¼Œå¹¶ä¸”å®ƒå¯ä»¥åœ¨çŸ¥é“ä½ å·²ç™»å½•çš„æƒ…å†µä¸‹æ­£ç¡®å“åº”ã€‚
> 4. ç„¶åä½ ç‚¹å¼€äº†ä¸€ä¸ªå…¶ä»–çš„ç½‘ç«™
> 5. æ¥ä¸‹æ¥ï¼Œè¯¥ç½‘ç«™ä¼šåƒä½ çš„æœåŠ¡å™¨å‘é€äº†è¯·æ±‚ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œç”±äºä½ çš„ cookie å·²ç»å­˜åœ¨ã€‚æ‰€ä»¥æœåŠ¡ç«¯ä¼šè®¤ä¸ºè¿™æ˜¯ä½ çš„æ­£å¸¸è¯·æ±‚
> 6. å› æ­¤æœåŠ¡å™¨ä¼šè¿”å›ä½ çš„é“¶è¡Œä¿¡æ¯ã€‚ä»è€Œå¯¼è‡´ä½ çš„é“¶è¡Œä¿¡æ¯ç›—å–ã€‚

è¿™ç§æƒ…å†µæ— ç–‘æ˜¯é£é™©æå¤§çš„ã€‚å› æ­¤æµè§ˆå™¨é‡‡ç”¨äº† **SOP**ï¼ˆåŒæºç­–ç•¥ï¼‰ï¼Œå®ƒè§„å®šäº†æµè§ˆå™¨ä¸­æ‰€æœ‰çš„æœåŠ¡è¯·æ±‚å¿…é¡»è¦æ»¡è¶³ä¸‰ä¸ªæ¡ä»¶ï¼š

- åŒ**åŸŸå**
- åŒ**åè®®**
- åŒ**ç«¯å£**

å¦‚æœæœ‰ä¸€ä¸ªæ¡ä»¶ä¸æ»¡è¶³ï¼Œåˆ™ä¼šè§¦å‘ **è·¨åŸŸé—®é¢˜**ï¼Œå³ï¼šè¯·æ±‚è¢«é˜»æ­¢ã€‚å› æ­¤ä¸Šé¢æè¿°çš„åœºæ™¯åœ¨ç›®å‰çš„æ“ä½œä¸­ **ä¸ä¼šå­˜åœ¨**ï¼Œå› æ­¤æ— éœ€æ‹…å¿ƒã€‚

## è·¨åŸŸè®¿é—®

å› ä¸º SOPï¼ˆåŒæºç­–ç•¥ï¼‰çš„å­˜åœ¨ï¼Œæ‰€ä»¥ä¸€æ—¦è¿›è¡Œäº†å‰åç«¯çš„åˆ†ç¦»ï¼Œé‚£ä¹ˆé—®é¢˜å°±æ¥äº†ï¼Œä½ ä¼šå‘ç°ï¼š**è¯·æ±‚å‡ºç°äº†è·¨åŸŸ**ã€‚å› ä¸ºåœ¨å‰åç«¯åˆ†ç¦»çš„ç­–ç•¥ä¸‹ï¼Œå‰ç«¯å’Œåç«¯çš„é¡¹ç›®éƒ½ä¼šåˆ†å¼€éƒ¨ç½²ã€‚

ä¾‹å¦‚ï¼Œå¦‚ä¸‹åœºæ™¯

### CORSï¼ˆè·¨æºèµ„æºå…±äº«ï¼‰

å½“ sunday.com çš„ Web åº”ç”¨å°è¯•ä» admin.com è¯·æ±‚èµ„æºæ—¶ï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨åœ¨è¯·æ±‚ä¸­åŒ…å« Origin æ ‡å¤´ï¼ŒæŒ‡ç¤ºè¯·æ±‚æºè‡ªä½•å¤„ (sunday.com)ã€‚ æ­¤æ—¶ï¼šadmin.com çš„æœåŠ¡å™¨ä¸ä¼šæ ¹æ® SOP å½»åº•é˜»æ­¢æ­¤ç±»è·¨æºè¯·æ±‚ï¼Œè€Œæ˜¯å¯ä»¥æ£€æŸ¥æ­¤ Origin æ ‡å¤´ï¼Œå¹¶æ ¹æ®è‡ªå·±çš„ CORS ç­–ç•¥å†³å®šæ˜¯å¦å…è®¸æˆ–æ‹’ç»è¯¥è¯·æ±‚ã€‚

å¦‚æœ admin.com è®¤ä¸º sunday.com å€¼å¾—ä¿¡èµ–ï¼Œæˆ–è€…æ‰€è¯·æ±‚çš„èµ„æºå¯ä»¥å…¬å¼€è®¿é—®ï¼Œåˆ™å®ƒå¯ä»¥ä½¿ç”¨ç‰¹å®šçš„CORSæ ‡å¤´è¿›è¡Œå“åº”ï¼Œä¾‹å¦‚`Access-Control-Allow-Origin`ï¼ŒæŒ‡ç¤ºå…è®¸å“ªäº›æºè®¿é—®è¯¥èµ„æºã€‚

æ­¤æ ‡å¤´å¯èƒ½è®¾ç½®ä¸º `http://example.com`ï¼Œæ˜ç¡®å…è®¸æ­¤æºï¼Œæˆ– `*` è¡¨ç¤ºä»»ä½•æºéƒ½å¯ä»¥è®¿é—®çš„å…¬å…±èµ„æºã€‚è¿™ä¹Ÿæ˜¯å¸¸è§çš„åç«¯å¤„ç†è·¨åŸŸçš„æ–¹å¼ã€‚

ä½†æ˜¯æ­¤æ—¶ï¼Œæˆ‘ä»¬éœ€è¦æ³¨æ„ï¼š**å¦‚æœè¯·æ±‚æ²¡æœ‰ Origin æ ‡å¤´æ€ä¹ˆåŠï¼Ÿ**

å¦‚æœè¯·æ±‚æ²¡æœ‰ Origin æ ‡å¤´ï¼Œé€šå¸¸æ˜¯å› ä¸ºè¯·æ±‚æ˜¯é€šè¿‡éæµè§ˆå™¨å‘èµ·çš„ï¼Œæˆ–è€…æ˜¯å› ä¸ºæµè§ˆå™¨çš„åŒæºç­–ç•¥ç¦æ­¢äº†å¯¹è·¨æºè¯·æ±‚çš„ Origin æ ‡å¤´çš„å‘é€ï¼ˆä¾‹å¦‚å‘é€ç»™ file:// æˆ– data:// URIï¼‰ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæµè§ˆå™¨ä¸ä¼šå‘é€ Origin æ ‡å¤´ï¼Œå¹¶ä¸” CORS çš„å¤„ç†ä¼šå˜å¾—æ›´åŠ å¤æ‚ï¼Œå› ä¸ºå®ƒä¸å†æ˜¯ä¸€ä¸ªâ€œç®€å•çš„è¯·æ±‚â€ã€‚è¿™æ—¶å¯èƒ½éœ€è¦ä½¿ç”¨ CORS ä¸­çš„é¢„æ£€è¯·æ±‚æ¥è¿›è¡Œå¤„ç†ï¼Œä»¥ç¡®å®šæ˜¯å¦å…è®¸å®é™…çš„è¯·æ±‚ã€‚

### **é¢„æ£€è¯·æ±‚**

å½“æµè§ˆå™¨åœ¨å‘é€æŸäº›ç±»å‹çš„å¯èƒ½ä¿®æ”¹æœåŠ¡å™¨ä¸Šæ•°æ®çš„è¯·æ±‚ï¼ˆå¦‚ PUTã€DELETE æ–¹æ³•ï¼‰ï¼Œæˆ–è€…å‘é€åŒ…å«ä¸ä¼šè‡ªåŠ¨åŒ…å«åœ¨æ¯ä¸ªè¯·æ±‚ä¸­çš„æ ‡å¤´çš„è¯·æ±‚æ—¶ï¼Œä¼šå…ˆå‘é€ä¸€ä¸ªé¢„æ£€è¯·æ±‚ï¼Œå³ OPTIONS è¯·æ±‚ã€‚

é¢„æ£€è¯·æ±‚çš„ç›®çš„æ˜¯å‘æœåŠ¡å™¨æ£€æŸ¥å®é™…è¯·æ±‚æ˜¯å¦å¯ä»¥å®‰å…¨å‘é€ã€‚é¢„æ£€è¯·æ±‚ä¼šåŒ…æ‹¬æè¿° HTTP æ–¹æ³•çš„æ ‡å¤´å’Œå®é™…è¯·æ±‚çš„æ ‡å¤´ã€‚

æœåŠ¡å™¨åœ¨æ”¶åˆ°é¢„æ£€è¯·æ±‚åï¼Œå¦‚æœæ”¯æŒ CORS ç­–ç•¥å¹¶ä¸”å…è®¸å®é™…è¯·æ±‚ï¼Œä¼šä½¿ç”¨ç‰¹å®šçš„ CORS æ ‡å¤´ï¼ˆå¦‚ Access-Control-Allow-Methods å’Œ Access-Control-Allow-Headersï¼‰æ¥å“åº”é¢„æ£€è¯·æ±‚ï¼ŒæŒ‡ç¤ºå…è®¸å“ªäº›æ–¹æ³•å’Œæ ‡å¤´ã€‚

æµè§ˆå™¨æ ¹æ®æœåŠ¡å™¨å¯¹é¢„æ£€è¯·æ±‚çš„å“åº”æ¥å†³å®šæ˜¯å¦ç»§ç»­å¤„ç†å®é™…è¯·æ±‚ã€‚å¦‚æœæœåŠ¡å™¨çš„å“åº”è¡¨æ˜è¯¥è¯·æ±‚è¢«å…è®¸ï¼Œåˆ™æµè§ˆå™¨ä¼šå‘é€å®é™…è¯·æ±‚ï¼›å¦åˆ™ï¼Œæµè§ˆå™¨å°†é˜»æ­¢è¯¥è¯·æ±‚ï¼Œå¹¶æ˜¾ç¤ºä¸ CORS ç›¸å…³çš„é”™è¯¯ã€‚

## è§£å†³åŠæ³•

> - **CORS æ”¯æŒæ‰€æœ‰çš„ HTTP è¯·æ±‚ï¼Œæ˜¯è·¨åŸŸæœ€ä¸»æµçš„æ–¹æ¡ˆ**
> - **JSONP åªæ”¯æŒ GET è¯·æ±‚ï¼Œä½†æ˜¯å¯ä»¥å…¼å®¹è€å¼æµè§ˆå™¨**
> - **Node ä¸­é—´ä»¶å’Œ Nginx åå‘ä»£ç†éƒ½æ˜¯åˆ©ç”¨äº†æœåŠ¡å™¨å¯¹æœåŠ¡å™¨æ²¡æœ‰åŒæºç­–ç•¥é™åˆ¶**
> - **Websocket ä¹Ÿæ˜¯ä¸€ç§è·¨åŸŸçš„è§£å†³æ–¹æ¡ˆ**
> - **PostMessage å¯ä»¥å®ç°è·¨æ–‡æ¡£é€šä¿¡ï¼Œæ›´å¤šåœ°ç”¨äºçª—å£é€šä¿¡**
> - **document.domain, window.name, location.hash é€æ¸æ·¡å‡ºå†å²èˆå°ï¼Œä½œä¸ºæ›¿ä»£ PostMessage æ˜¯ä¸€ç§ä¸é”™çš„æ–¹æ¡ˆ**

### JSONP

> ]JSONP çš„ä¼˜ç‚¹æ˜¯ç®€å•è€Œä¸”å…¼å®¹æ€§å¾ˆå¥½ï¼Œä½†æ˜¯ç¼ºç‚¹ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œ**éœ€è¦æœåŠ¡å™¨æ”¯æŒè€Œä¸”åªæ”¯æŒ GET è¯·æ±‚**

```js
function jsonp(url, params_obj, callback) {
 //åˆ›å»ºä¸€ä¸ªä¾›åç«¯è¿”å›æ•°æ®è°ƒç”¨çš„å‡½æ•°å
 let funcName = 'jsonp_' + Data.now() + Math.random().toString().substr(2, 5)

 //å°†å‚æ•°æ‹¼æ¥æˆå­—ç¬¦ä¸²
 if (typeof params==='object') {
  let temp=[]
  for (let key in params) {
   temp.push(`${key}=${params[key]}`)
  }
  params=temp.join('&')
 }

 //åœ¨htmlä¸­æ’å…¥<script>èµ„æºè¯·æ±‚æ ‡ç­¾
 let script=document.createElement('script')
 script.src=`${url}?${params}&callback=${funcName}`
 document.body.appendChild(script)

 //åœ¨æœ¬åœ°è®¾ç½®ä¾›åç«¯è¿”å›æ•°æ®æ—¶è°ƒç”¨çš„å‡½æ•°
 window[funcName]=data=>{
  callback(data)

  delete window[funcName]
  document.body.removeChild(script)
 }
}

//ä½¿ç”¨æ–¹æ³•
jsonp('http://xxxxxxxx',{id:123},data=>{
 //è·å–æ•°æ®åçš„æ“ä½œ
})
```

```js
// jsæ’å…¥htmlä¸­æ ‡ç­¾çš„å†…å®¹

<script src="https://www.liuzhuocheng.com?callback=funcName"></script>
```

```js
// åç«¯è¿”å›çš„<script>èµ„æºçš„å†…å®¹

<script src="https://www.liuzhuocheng.com?callback=funcName">
 funcName('datadatadatadatadatadatadatadata')
</script>
```

### CORS

**CORS**ï¼ˆCross-Origin Resource Sharingï¼‰çš„å…¨ç§°å« **è·¨åŸŸèµ„æºå…±äº«**ï¼Œåç§°å¥½é«˜å¤§ä¸Šï¼Œåˆ«æ€•ï¼Œè¿™ç©æ„å„¿å…¶å®å°±æ˜¯ä¸€ç§æœºåˆ¶ã€‚æµè§ˆå™¨ä¸æ˜¯æœ‰åŒæºç­–ç•¥å‘ï¼Œè¿™ä¸œè¥¿å¥½æ˜¯å¥½ï¼Œä½†æ˜¯å¯¹äºå¼€å‘äººå‘˜æ¥è¯´å°±ä¸æ€ä¹ˆå‹å¥½äº†ï¼Œå› ä¸ºæˆ‘ä»¬å¯èƒ½ç»å¸¸éœ€è¦å‘èµ·ä¸€ä¸ª **è·¨åŸŸ HTTP è¯·æ±‚**ã€‚æˆ‘ä»¬ä¹‹å‰è¯´è¿‡ï¼Œè·¨åŸŸçš„è¯·æ±‚å…¶å®æ˜¯å‘å‡ºå»äº†çš„ï¼Œåªä¸è¿‡è¢«æµè§ˆå™¨ç»™æ‹¦æˆªäº†ï¼Œå› ä¸ºä¸å®‰å…¨ï¼Œè¯´ç›´ç™½ç‚¹å„¿å°±æ˜¯ï¼Œ**ä½ æƒ³è¦ä»æœåŠ¡å™¨å“ªå„¿æ‹¿ä¸ªä¸œè¥¿ï¼Œä½†æ˜¯æ²¡æœ‰ç»è¿‡äººå®¶å…è®¸å•Š**ã€‚æ‰€ä»¥æ€ä¹ˆæ ·æ‰å®‰å…¨ ï¼ŸæœåŠ¡å™¨å…è®¸äº†ä¸å°±å®‰å…¨äº†ï¼Œè¿™å°±æ˜¯ CORS å®ç°çš„åŸç†ï¼š**ä½¿ç”¨é¢å¤–çš„ HTTP å¤´æ¥å‘Šè¯‰æµè§ˆå™¨ï¼Œè®©è¿è¡Œåœ¨æŸä¸€ä¸ª origin ä¸Šçš„ Web åº”ç”¨å…è®¸è®¿é—®æ¥è‡ªä¸åŒæºæœåŠ¡å™¨ä¸Šçš„æŒ‡å®šçš„èµ„æº**ã€‚

**å…¼å®¹æ€§**

ç›®å‰ï¼Œæ‰€æœ‰çš„ä¸»æµæµè§ˆå™¨éƒ½æ”¯æŒ CORSï¼Œå…¶ä¸­ï¼ŒIE æµè§ˆå™¨çš„ç‰ˆæœ¬ä¸èƒ½ä½äº 10ï¼Œ**IE 8 å’Œ 9 éœ€è¦é€šè¿‡ XDomainRequest æ¥å®ç°**ã€‚

**å®ç°åŸç†**

CORS éœ€è¦æµè§ˆå™¨å’ŒæœåŠ¡å™¨åŒæ—¶æ”¯æŒï¼Œæ•´ä¸ª CORS çš„é€šä¿¡è¿‡ç¨‹ï¼Œéƒ½æ˜¯æµè§ˆå™¨è‡ªåŠ¨å®Œæˆã€‚**æ€ä¹ˆä¸ªè‡ªåŠ¨æ³•** ï¼Ÿç®€å•æ¥è¯´ï¼Œæµè§ˆå™¨ä¸€æ—¦å‘ç°è¯·æ±‚æ˜¯ä¸€ä¸ª**è·¨åŸŸè¯·æ±‚**ï¼Œé¦–å…ˆä¼š**åˆ¤æ–­è¯·æ±‚çš„ç±»å‹**ï¼Œå¦‚æœæ˜¯**ç®€å•è¯·æ±‚**ï¼Œä¼šåœ¨è¯·æ±‚å¤´ä¸­å¢åŠ ä¸€ä¸ª **Origin** å­—æ®µï¼Œè¡¨ç¤ºè¿™æ¬¡è¯·æ±‚æ˜¯æ¥è‡ªå“ªä¸€ä¸ª**æº**ã€‚è€ŒæœåŠ¡å™¨æ¥å—åˆ°è¯·æ±‚åï¼Œä¼šè¿”å›ä¸€ä¸ªå“åº”ï¼Œå“åº”å¤´ä¸­ä¼šåŒ…å«ä¸€ä¸ªå« **Access-Control-Allow-Origin** çš„å­—æ®µï¼Œå®ƒçš„å€¼**è¦ä¹ˆåŒ…å«ç”± Origin é¦–éƒ¨å­—æ®µæ‰€æŒ‡æ˜çš„åŸŸåï¼Œè¦ä¹ˆæ˜¯ä¸€ä¸ª "\*"**ï¼Œè¡¨ç¤ºæ¥å—ä»»æ„åŸŸåçš„è¯·æ±‚ã€‚å¦‚æœå“åº”å¤´ä¸­æ²¡æœ‰è¿™ä¸ªå­—æ®µï¼Œå°±è¯´æ˜å½“å‰æºä¸åœ¨æœåŠ¡å™¨çš„è®¸å¯èŒƒå›´å†…ï¼Œæµè§ˆå™¨å°±ä¼šæŠ¥é”™:

```js
GET /cors HTTP/1.1
Origin: https://xxx.xx
Accept-Language: en-US
Connection: keep-alive... ...
```

å¦‚æœæ˜¯**éç®€å•è¯·æ±‚**ï¼Œä¼šåœ¨æ­£å¼é€šä¿¡ä¹‹å‰ï¼Œå‘é€ä¸€ä¸ª**é¢„æ£€è¯·æ±‚ï¼ˆpreflightï¼‰**ï¼Œç›®çš„åœ¨äºè¯¢é—®æœåŠ¡å™¨ï¼Œå½“å‰ç½‘é¡µæ‰€åœ¨çš„åŸŸåæ˜¯å¦åœ¨æœåŠ¡å™¨çš„è®¸å¯åå•ä¹‹ä¸­ï¼Œä»¥åŠå¯ä»¥ä½¿ç”¨å“ªäº› HTTP åŠ¨è¯å’Œå¤´ä¿¡æ¯å­—æ®µï¼Œåªæœ‰å¾—åˆ°è‚¯å®šç­”å¤ï¼Œæµè§ˆå™¨æ‰ä¼šå‘å‡ºæ­£å¼çš„è¯·æ±‚ï¼Œå¦åˆ™å°±æŠ¥é”™ã€‚ä½ å¯èƒ½å‘ç°æˆ‘ä»¬åœ¨æ—¥å¸¸çš„å¼€å‘ä¸­ï¼Œä¼šçœ‹åˆ°å¾ˆå¤šä½¿ç”¨ OPTION æ–¹æ³•å‘èµ·çš„è¯·æ±‚ï¼Œå®ƒå…¶å®å°±æ˜¯ä¸€ä¸ªé¢„æ£€è¯·æ±‚ï¼š

```js
OPTIONS /cors HTTP/1.1
Origin: http://xxx.xx
Access-Control-Request-Method: PUT
Accept-Language: en-US... ...
```

**é‚£ä¹ˆåˆ°åº•å“ªäº›æ˜¯ç®€å•è¯·æ±‚ï¼Œå“ªäº›æ˜¯éç®€å•è¯·æ±‚ ï¼Ÿ**

**è¯·æ±‚ç±»å‹**

ä¸ä¼šè§¦å‘ CORS é¢„æ£€çš„ï¼Œå°±æ˜¯ç®€å•è¯·æ±‚ã€‚å“ªäº›è¯·æ±‚ä¸ä¼šè§¦å‘é¢„æ£€ ï¼Ÿä½¿ç”¨ä»¥ä¸‹æ–¹æ³•ä¹‹ä¸€ï¼š**GET, HEAD, POST**,å¹¶ä¸” **Content-Type** çš„å€¼ä»…é™äºä¸‹åˆ—ä¸‰è€…ä¹‹ä¸€ï¼š

- text/plain
- multipart/form-data
- application/x-www-form-urlencoded

ç›¸åï¼Œä¸ç¬¦åˆä¸Šè¿°æ¡ä»¶çš„å°±æ˜¯éç®€å•è¯·æ±‚å•¦ã€‚æ‰€ä»¥ï¼Œ**å®ç° CORS çš„å…³é”®æ˜¯æœåŠ¡å™¨**ï¼Œåªè¦æœåŠ¡å™¨å®ç°äº† CORS çš„ç›¸å…³æ¥å£ï¼Œå°±å¯ä»¥å®ç°è·¨åŸŸã€‚CORS ä¸ JSONPç›¸æ¯”ï¼Œä¼˜åŠ¿æ˜¯æ”¯æŒæ‰€æœ‰çš„è¯·æ±‚æ–¹æ³•ï¼Œç¼ºç‚¹æ˜¯å…¼å®¹æ€§ä¸Šè¾ƒ JSONP å·®ã€‚é™¤äº† JSONP å’Œ CORS å¤–ï¼Œè¿˜æœ‰ä¸€ç§å¸¸ç”¨çš„è·¨åŸŸè§£å†³æ–¹æ¡ˆï¼šPostMessageï¼Œå®ƒ**æ›´å¤šåœ°ç”¨äºçª—å£é—´çš„æ¶ˆæ¯ä¼ é€’ã€‚**

### document.domain

äºŒçº§åŸŸåç›¸åŒçš„æƒ…å†µä¸‹ï¼Œè®¾ç½® document.domain å°±å¯ä»¥å®ç°è·¨åŸŸã€‚**ä»€ä¹ˆæ˜¯äºŒçº§åŸŸå ï¼Ÿ**a.test.com å’Œ b.test.com å°±å±äºäºŒçº§åŸŸåï¼Œå®ƒä»¬éƒ½æ˜¯ test.com çš„å­åŸŸã€‚å¦‚ä½•å®ç°è·¨åŸŸ ï¼Ÿ

```js
document.domain = 'test.com' // è®¾ç½® domain ç›¸åŒ

// é€šè¿‡ iframe åµŒå…¥è·¨åŸŸçš„é¡µé¢
const iframe = document.createElement('iframe')
iframe.setAttribute('src', 'b.test.com/xxx.html')
iframe.onload = function() {
  // æ‹¿åˆ° iframe å®ä¾‹åå°±å¯ä»¥ç›´æ¥è®¿é—® iframe ä¸­çš„æ•°æ®
  console.log(iframe.contentWindow.xxx)
}
document.appendChild(iframe)
```

### Node ä¸­é—´ä»¶ä»£ç†

å®ç°çš„åŸç†å’Œæˆ‘ä»¬å‰æ–‡æåˆ°çš„ä»£ç†æœåŠ¡å™¨åŸç†å¦‚å‡ºä¸€è¾™ï¼Œåªä¸è¿‡è¿™é‡Œä½¿ç”¨äº† Node ä¸­é—´ä»¶ä½œä¸ºä»£ç†ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ**æµè§ˆå™¨å‘ä»£ç†æœåŠ¡å™¨è¯·æ±‚æ—¶ä»ç„¶éµå¾ªåŒæºç­–ç•¥**ï¼Œåˆ«å¿˜äº†åœ¨ Node å±‚é€šè¿‡ CORS åšè·¨åŸŸå¤„ç†ï¼š

```js
const https = require('https')
// æ¥å—å®¢æˆ·ç«¯è¯·æ±‚
const sever = https.createServer((req, res) => {
  ...
  const { method, headers } = req
  // è®¾ç½® CORS å…è®¸è·¨åŸŸ
  res.writeHead(200, {
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Methods': '*',
    'Access-Control-Allow-Headers': 'Content-Type',
    ...
  })
  // è¯·æ±‚æœåŠ¡å™¨
  const proxy = https.request({ host: 'xxx', method, headers, ...}, response => {
    let body = ''
    response.on('data', chunk => { body = body + chunk })
    response.on('end', () => {
      // å“åº”ç»“æœè½¬å‘ç»™å®¢æˆ·ç«¯
      res.end(body)
    })
  })
  // ç»“æŸè¯·æ±‚
  proxy.end()
})
```

### Nginx åå‘ä»£ç†

æˆ‘ä»¬çŸ¥é“åŒæºç­–ç•¥é™åˆ¶çš„æ˜¯ï¼šæµè§ˆå™¨å‘æœåŠ¡å™¨å‘é€è·¨åŸŸè¯·æ±‚éœ€è¦éµå¾ªçš„æ ‡å‡†ï¼Œé‚£å¦‚æœæ˜¯**æœåŠ¡å™¨å‘æœåŠ¡å™¨å‘é€è·¨åŸŸè¯·æ±‚**å‘¢ï¼Ÿç­”æ¡ˆå½“ç„¶æ˜¯ï¼Œ**ä¸å—æµè§ˆå™¨çš„åŒæºç­–ç•¥é™åˆ¶**ã€‚åˆ©ç”¨è¿™ä¸ªæ€è·¯ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ­å»ºä¸€ä¸ªä»£ç†æœåŠ¡å™¨ï¼Œæ¥å—å®¢æˆ·ç«¯è¯·æ±‚ï¼Œç„¶åå°†è¯·æ±‚è½¬å‘ç»™æœåŠ¡å™¨ï¼Œæ‹¿åˆ°å“åº”åï¼Œå†å°†å“åº”è½¬å‘ç»™å®¢æˆ·ç«¯ï¼š![1713610441946](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1713610441946.png)è¿™å°±æ˜¯ Nginx åå‘ä»£ç†çš„åŸç†ï¼Œåªéœ€è¦ç®€å•é…ç½®å°±å¯ä»¥å®ç°è·¨åŸŸï¼š

```js
# nginx.config
# ...
server {
  listen       80;
  server_name  www.domain1.com;
  location / {
    proxy_pass   http://www.domain2.com:8080;  #åå‘ä»£ç†
    proxy_cookie_domain www.domain2.com www.domain1.com; #ä¿®æ”¹cookieé‡ŒåŸŸå
    index  index.html index.htm;

    # å½“ç”¨ webpack-dev-server ç­‰ä¸­é—´ä»¶ä»£ç†æ¥å£è®¿é—® nignx æ—¶ï¼Œæ­¤æ—¶æ— æµè§ˆå™¨å‚ä¸ï¼Œæ•…æ²¡æœ‰åŒæºé™åˆ¶ï¼Œä¸‹é¢çš„è·¨åŸŸé…ç½®å¯ä¸å¯ç”¨
    add_header Access-Control-Allow-Origin *;
    add_header Access-Control-Allow-Credentials true;
    # ...
  }
}
```

### Websocket

Websocket æ˜¯ HTML5 çš„ä¸€ä¸ªæŒä¹…åŒ–çš„åè®®ï¼Œå®ƒ**å®ç°äº†æµè§ˆå™¨ä¸æœåŠ¡å™¨çš„å…¨åŒå·¥é€šä¿¡**ï¼ŒåŒæ—¶ä¹Ÿæ˜¯è·¨åŸŸçš„ä¸€ç§è§£å†³æ–¹æ¡ˆã€‚ä»€ä¹ˆæ˜¯å…¨åŒå·¥é€šä¿¡ ï¼Ÿç®€å•æ¥è¯´ï¼Œ**å°±æ˜¯åœ¨å»ºç«‹è¿æ¥ä¹‹åï¼Œserver ä¸ client éƒ½èƒ½ä¸»åŠ¨å‘å¯¹æ–¹å‘é€æˆ–æ¥æ”¶æ•°æ®**ã€‚åŸç”Ÿçš„ WebSocket API ä½¿ç”¨èµ·æ¥ä¸å¤ªæ–¹ä¾¿ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šé€‰æ‹©è‡ªå·±å°è£…ä¸€ä¸ª Websocketï¼ˆå—¯ï¼Œæˆ‘ä»¬å›¢é˜Ÿä¹Ÿè‡ªå·±å°äº†ä¸€ä¸ª : ï¼‰ï¼‰æˆ–è€…ä½¿ç”¨å·²æœ‰çš„ç¬¬ä¸‰æ–¹åº“ï¼Œæˆ‘ä»¬è¿™é‡Œä»¥ç¬¬ä¸‰æ–¹åº“ **ws**[7] ä¸ºä¾‹ï¼š

```js
const WebSocket = require('ws');

const ws = new WebSocket('ws://www.host.com/path');

ws.on('open', function open() {
  ws.send('something');
});

ws.on('message', function incoming(data) {
  console.log(data);
});
... ...
```

éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒWebsocket å±äºé•¿è¿æ¥ï¼Œåœ¨ä¸€ä¸ªé¡µé¢å»ºç«‹å¤šä¸ª Websocket è¿æ¥å¯èƒ½ä¼šå¯¼è‡´æ€§èƒ½é—®é¢˜ã€‚

### PostMessage

PostMessage æ˜¯ Html5 XMLHttpRequest Level 2 ä¸­çš„ APIï¼Œå®ƒå¯ä»¥å®ç°**è·¨æ–‡æ¡£é€šä¿¡ï¼ˆCross-document messagingï¼‰**ã€‚å…¼å®¹æ€§ä¸Šï¼ŒIE8+ï¼ŒChromeï¼ŒFirfox ç­‰ä¸»æµæµè§ˆå™¨éƒ½æ”¯æŒï¼Œå¯ä»¥æ”¾å¿ƒç”¨ğŸ˜Šï¼Œå¦‚ä½•ç†è§£è·¨æ–‡æ¡£é€šä¿¡ï¼Ÿä½ å¯ä»¥ç±»æ¯”è®¾è®¡æ¨¡å¼ä¸­çš„**å‘å¸ƒ-è®¢é˜…æ¨¡å¼**ï¼Œåœ¨è¿™é‡Œï¼Œä¸€ä¸ªçª—å£å‘é€æ¶ˆæ¯ï¼Œå¦ä¸€ä¸ªçª—å£æ¥å—æ¶ˆæ¯ï¼Œä¹‹æ‰€ä»¥è¯´ç±»ä¼¼å‘å¸ƒ-è®¢é˜…æ¨¡å¼ï¼Œè€Œä¸æ˜¯**è§‚å¯Ÿè€…æ¨¡å¼**ï¼Œæ˜¯å› ä¸ºè¿™é‡Œä¸¤ä¸ªçª—å£é—´æ²¡æœ‰ç›´æ¥é€šä¿¡ï¼Œè€Œæ˜¯é€šè¿‡æµè§ˆå™¨è¿™ä¸ªç¬¬ä¸‰æ–¹å¹³å°ã€‚

```js
window.postMessage(message, origin, [transfer])
```

postMessage æ–¹æ³•æ¥æ”¶ä¸‰ä¸ªå‚æ•°ï¼Œè¦å‘é€çš„æ¶ˆæ¯ï¼Œæ¥æ”¶æ¶ˆæ¯çš„æºå’Œä¸€ä¸ªå¯é€‰çš„ Transferable å¯¹è±¡ï¼Œ**å¦‚ä½•æ¥æ”¶æ¶ˆæ¯ ï¼Ÿ**

```js
window.addEventListener("message", function receiveMessage(event) {}, false); // æ¨èï¼Œå…¼å®¹æ€§æ›´å¥½

window.onmessage = function receiveMessage(event) {} // ä¸æ¨èï¼Œè¿™æ˜¯ä¸€ä¸ªå®éªŒæ€§çš„åŠŸèƒ½ï¼Œå…¼å®¹æ€§ä¸å¦‚ä¸Šé¢çš„æ–¹æ³•
```

æ¥æ”¶åˆ°æ¶ˆæ¯åï¼Œæ¶ˆæ¯å¯¹è±¡ event ä¸­åŒ…å«äº†ä¸‰ä¸ªå±æ€§ï¼š**sourceï¼Œoriginï¼Œdata**ï¼Œå…¶ä¸­ data å°±æ˜¯æˆ‘ä»¬å‘é€çš„ messageã€‚æ­¤å¤–ï¼Œé™¤äº†å®ç°çª—å£é€šä¿¡ï¼ŒpostMessage è¿˜å¯ä»¥åŒ Web Worker å’Œ Service Work è¿›è¡Œé€šä¿¡

## è·¨åŸŸè¯·æ±‚å¦‚ä½•æºå¸¦cookie

### æ­å»ºä¸€ä¸ªè·¨åŸŸè¯·æ±‚çš„ç¯å¢ƒ

**æ€è·¯ï¼š**

1. ä½¿ç”¨`express`æ­å»ºç¬¬ä¸€ä¸ªæœåŠ¡`A`(`http://localhost:8000`)ï¼Œè¿è¡Œåœ¨`8000`ç«¯å£ä¸Šï¼›
2. `A`æœåŠ¡æ‰˜ç®¡`index.html`(ç”¨äºåœ¨å‰ç«¯é¡µé¢å‘é€ç½‘ç»œè¯·æ±‚)æ–‡ä»¶ï¼›
3. åœ¨`A`æœåŠ¡ä¸­å†™ä¸€ä¸ªå¤„ç†è¯·æ±‚çš„è·¯ç”±ï¼ŒåŠ è½½`index.html`é¡µé¢æ—¶ï¼Œç§ä¸‹`cookie`(è¿™é‡Œç§`cookie`ä¸ºäº†åœ¨è¯·æ±‚`B`æœåŠ¡æ—¶æºå¸¦ä¸Š);
4. ä½¿ç”¨`express`æ­å»ºç¬¬äºŒä¸ªæœåŠ¡`B`(`http://localhost:8003`)ï¼Œè¿è¡Œåœ¨`8003`ç«¯å£ä¸Šï¼›
5. åœ¨`A`æœåŠ¡æ‰˜ç®¡çš„`index.html`é¡µé¢å»è¯·æ±‚`B`æœåŠ¡ï¼Œç„¶åæŠŠ`cookie`ä¼ è¿‡å»ï¼›

å…ˆçœ‹ä¸‹ä»£ç ç»“æ„ï¼Œç›¸å¯¹æ¯”è¾ƒçš„ç®€å•ï¼š

![1713610810604](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1713610810604.png)

`A`æœåŠ¡çš„ä»£ç ï¼š

```js
// src/app1.js
const express = require("express");
const app = express();

// `index.html` åŠ è½½æ—¶ä¼šè¯·æ±‚loginæ¥å£
// è®¾ç½®`cookie`
app.get("/login", (req, res) => {
  res.cookie("user", "jay", { maxAge: 2000000, httpOnly: true });
  res.json({ code: 0, message: "ç™»å½•æˆåŠŸ" });
});

// æ­¤æ¥å£æ˜¯æ£€æµ‹`cookie`æ˜¯å¦è®¾ç½®æˆåŠŸï¼Œå¦‚æœè®¾ç½®æˆåŠŸçš„è¯ï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨æºå¸¦ä¸Š`cookie`
app.get("/user", (req, res) => {
  // req.headers.cookie: user=jay
  const user = req.headers.cookie.split("=")[1];
  res.json({ code: 0, user });
});

// æ‰˜ç®¡`index.html`é¡µé¢
// è¿™æ ·çš„è¯åœ¨`index.html`ä¸­å‘èµ·çš„è¯·æ±‚ï¼Œé»˜è®¤çš„æºå°±æ˜¯`http://localhost:8000`
// ç„¶åå†å»è¯·æ±‚`http://localhost:8003`å°±ä¼šå‡ºç°è·¨åŸŸäº†
app.use("/static", express.static("public"));

app.listen("8000", () => {
  console.log("app1 running at port 8000");
});
```

`index.html`çš„ä»£ç ï¼š

```js
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <h2>this is index.html at port 8000</h2>
    <button id="button">å‘é€åŒæºè¯·æ±‚</button>
    <button id="cross-button">å‘é€è·¨åŸŸè¯·æ±‚</button>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
      const button = document.querySelector("#button");
      const crossButton = document.querySelector("#cross-button");

      axios.get("http://localhost:8000/login", {}).then((res) => {
        console.log(res);
      });
      // å‘é€åŒåŸŸè¯·æ±‚
      button.onclick = function () {
        axios.get("http://localhost:8000/user", {}).then((res) => {
          console.log(res);
        });
      };
      // å‘é€è·¨åŸŸè¯·æ±‚
      crossButton.onclick = function () {
        axios({
          method: "get",
          url: "http://localhost:8003/anotherService",
        }).then((res) => {
          console.log(res);
        });
      };
    </script>
  </body>
</html>
```

`B`æœåŠ¡çš„ä»£ç ï¼š

```js
// src/app2.js
const express = require("express");
const app = express();

// å®šä¹‰ä¸€ä¸ªæ¥å£ï¼Œindex.htmlé¡µé¢è¯·æ±‚è¿™ä¸ªæ¥å£å°±æ˜¯è·¨åŸŸï¼ˆå› ä¸ºç«¯å£ä¸åŒï¼‰
app.get("/anotherService", (req, res) => {
  res.json({ code: 0, msg: "è¿™æ˜¯8003ç«¯å£è¿”å›çš„" });
});

app.listen("8003", () => {
  console.log("app2 running at port 8003");
});
```

è¿™ä¸ªæ—¶å€™ç¯å¢ƒåŸºæœ¬å°±æ­å»ºå¥½äº†ã€‚

### è§£å†³è·¨åŸŸæºå¸¦`cookie`é—®é¢˜

é¦–å…ˆæˆ‘ä»¬å…ˆåœ¨`A`æœåŠ¡çš„`index.html`é¡µé¢ä¸­å¾—åˆ°ä¸€ä¸ª`cookie`,è¿è¡Œ`A`æœåŠ¡ï¼š

```js
npm install express -D
node src/app1.js
```

ç„¶åæ‰“å¼€`http://localhost:8000/static/index.html`: æ²¡æœ‰é—®é¢˜çš„è¯ï¼Œé¡µé¢é•¿è¿™æ ·ï¼š

![1713610915629](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1713610915629.png)

è¿™ä¸ªæ—¶å€™`F12`æ‰“å¼€æ§åˆ¶å°ï¼šå¯ä»¥çœ‹åˆ°å‘é€äº†ä¸€ä¸ª`login`è¯·æ±‚ï¼Œå¹¶ä¸”è®¾ç½®äº†cookie,ä¹Ÿå¯ä»¥é€‰æ‹©æµè§ˆå™¨æ§åˆ¶å°çš„`Application`é¡µç­¾ï¼Œé€‰ä¸­`cookie`ï¼Œå¯ä»¥çœ‹åˆ°`cookie`çš„ä¿¡æ¯ï¼š

![1713610930498](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1713610930498.png)

![1713610942212](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1713610942212.png)

ç„¶åæˆ‘ä»¬ç‚¹å‡»é¡µé¢ä¸Šçš„**å‘é€åŒæºè¯·æ±‚**æŒ‰é’®ï¼Œå¯ä»¥çœ‹åˆ°å‘é€äº†ä¸€ä¸ªuserè¯·æ±‚ï¼Œå¹¶ä¸”å·²ç»æºå¸¦ä¸Šäº†cookieï¼š

![1713610959537](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1713610959537.png)

æ¥ä¸‹æ¥åˆºæ¿€çš„ç”»é¢æ¥äº†ï¼Œæˆ‘ä»¬ç‚¹å‡» **å‘é€è·¨åŸŸè¯·æ±‚** æŒ‰é’®ï¼Œå‡ºç°äº†è·¨åŸŸè¯·æ±‚çš„æŠ¥é”™ï¼š

![1713610974633](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1713610974633.png)

**é‡ç‚¹**ï¼šæ¥ä¸‹æ¥å¼€å§‹è§£å†³è·¨åŸŸæºå¸¦cookieé—®é¢˜ï¼š

#### 1. åœ¨å‰ç«¯è¯·æ±‚çš„æ—¶å€™è®¾ç½®requestå¯¹è±¡çš„å±æ€§withCredentialsä¸ºtrue;

ä»€ä¹ˆæ˜¯`withCredentials`ï¼Ÿ

**XMLHttpRequest.withCredentials** å±æ€§æ˜¯ä¸€ä¸ª`Boolean`ç±»å‹ï¼Œå®ƒæŒ‡ç¤ºäº†æ˜¯å¦è¯¥ä½¿ç”¨ç±»ä¼¼cookies,authorization headers(å¤´éƒ¨æˆæƒ)æˆ–è€…TLSå®¢æˆ·ç«¯è¯ä¹¦è¿™ä¸€ç±»èµ„æ ¼è¯ä¹¦æ¥åˆ›å»ºä¸€ä¸ªè·¨ç«™ç‚¹è®¿é—®æ§åˆ¶ï¼ˆcross-site `Access-Control`ï¼‰è¯·æ±‚ã€‚åœ¨åŒä¸€ä¸ªç«™ç‚¹ä¸‹ä½¿ç”¨`withCredentialså±æ€§æ˜¯æ— æ•ˆçš„ã€‚`

å¦‚æœåœ¨å‘é€æ¥è‡ªå…¶ä»–åŸŸçš„XMLHttpRequestè¯·æ±‚ä¹‹å‰ï¼Œæœªè®¾ç½®`withCredentials` ä¸ºtrueï¼Œé‚£ä¹ˆå°±ä¸èƒ½ä¸ºå®ƒè‡ªå·±çš„åŸŸè®¾ç½®cookieå€¼ã€‚è€Œé€šè¿‡è®¾ç½®`withCredentials` ä¸ºtrueè·å¾—çš„ç¬¬ä¸‰æ–¹cookiesï¼Œå°†ä¼šä¾æ—§äº«å—åŒæºç­–ç•¥ï¼Œå› æ­¤ä¸èƒ½è¢«é€šè¿‡document.cookieæˆ–è€…ä»å¤´éƒ¨ç›¸åº”è¯·æ±‚çš„è„šæœ¬ç­‰è®¿é—®ã€‚

```js
// ä¿®æ”¹è·¨åŸŸè¯·æ±‚çš„ä»£ç 
crossButton.onclick = function () {
    axios({
      withCredentials: true, // ++ æ–°å¢
      method: "get",
      url: "http://localhost:8003/anotherService",
    }).then((res) => {
      console.log(res);
    });
};
```

è¿™ä¸ªæ—¶å€™å†å»å‘é€ä¸€ä¸ªè·¨åŸŸè¯·æ±‚ï¼Œä½ ä¼šå‘ç°ä¾æ—§æŠ¥é”™ï¼Œä½†æ˜¯æˆ‘ä»¬ä»”ç»†çœ‹ä¸‹æŠ¥é”™ï¼Œæ„æ€æ˜¯éœ€è¦è®¾ç½®headerçš„`Access-Control-Allow-Origin`å±æ€§ï¼š

![1713611035808](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1713611035808.png)

#### 2. åœ¨æœåŠ¡ç«¯è®¾ç½®`Access-Control-Allow-Origin`

æˆ‘ä»¬ä¿®æ”¹`B`(app2.js)æœåŠ¡çš„ä»£ç ï¼š

```js
// åœ¨æ‰€æœ‰è·¯ç”±å‰å¢åŠ ï¼Œå¯ä»¥æ‹¦æˆªæ‰€æœ‰è¯·æ±‚
app.all("*", (req, res, next) => {
  res.header("Access-Control-Allow-Origin", "http://localhost:8000");
  next();
});
```

ä¿®æ”¹å®Œä¹‹åå†æ¬¡å‘é€ä¸€ä¸ªè·¨åŸŸè¯·æ±‚ï¼Œä½ ä¼šå‘ç°ï¼ŒåˆæŠ¥é”™äº†(æ¥è¿‘å´©æºƒ)ï¼Œä½†æ˜¯è·Ÿä¹‹å‰æŠ¥çš„é”™ä¸ä¸€æ ·äº†ï¼Œæ„æ€å¤§æ¦‚å°±æ˜¯`Access-Control-Allow-Credentials`è¿™ä¸ªå±æ€§åº”è¯¥è®¾ç½®ä¸º`true`ï¼Œä½†æ˜¯æ˜¾ç¤ºå¾—åˆ°çš„æ˜¯ä¸ª`''`ï¼š

![å›¾ç‰‡](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1713611073433.png)

#### 3. åœ¨æœåŠ¡ç«¯è®¾ç½®`Access-Control-Allow-Credentials`

å†æ¬¡ä¿®æ”¹BæœåŠ¡çš„ä»£ç ï¼ˆæ¯æ¬¡ä¿®æ”¹åéœ€è¦é‡æ–°è¿è¡Œï¼‰ï¼š

```js
// åœ¨æ‰€æœ‰è·¯ç”±å‰å¢åŠ ï¼Œå¯ä»¥æ‹¦æˆªæ‰€æœ‰è¯·æ±‚
app.all("*", (req, res, next) => {
  res.header("Access-Control-Allow-Origin", "http://localhost:8000");
  res.header("Access-Control-Allow-Credentials", "true"); // ++ æ–°å¢
  next();
});
```

å†å‘é€ä¸€ä¸ªè·¨åŸŸè¯·æ±‚ï¼š

![1713611094020](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1713611094020.png)

![1713611105324](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1713611105324.png)

å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªè·¨åŸŸè¯·æ±‚å·²ç»è¯·æ±‚æˆåŠŸå¹¶ä¸”è¿”å›æ•°æ®äº†ï¼è€Œä¸”ä¹Ÿæºå¸¦äº†`A`æœåŠ¡çš„`cookie`ï¼Œè¿™ä¸ªæ—¶å€™å·²ç»å¤§åŠŸå‘Šæˆäº†ã€‚

### æ€»ç»“

1. å‰ç«¯è¯·æ±‚æ—¶åœ¨`request`å¯¹è±¡ä¸­é…ç½®`"withCredentials": true`ï¼›
2. æœåŠ¡ç«¯åœ¨`response`çš„`header`ä¸­é…ç½®`"Access-Control-Allow-Origin", "http://xxx:${port}"`;
3. æœåŠ¡ç«¯åœ¨`response`çš„`header`ä¸­é…ç½®`"Access-Control-Allow-Credentials", "true"`

