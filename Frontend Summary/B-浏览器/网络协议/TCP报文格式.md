# 【网络协议】精讲TCP报文格式！图解超赞超详细！！！

**\1. TCP定义**

​      传输控制协议（英语：Transmission Control Protocol，缩写：TCP）是一种面向连接的、可靠的、基于字节流的传输层通信协议，由IETF的RFC 793定义。在简化的计算机网络OSI模型中，它完成第四层传输层所指定的功能。用户数据报协议（UDP）是同一层内另一个重要的传输协议。

**\2. TCP报文格式分析**

​    TCP 报文是 TCP 层传输的数据单元，也叫报文段。TCP 报文的格式如下图所示：

![1719139680962](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1719139680962.png)

**2.1 TCP头字段详细说明（****重点关注红色内容****）**

- **源端口：**16位，源端口和IP地址的作用是标识报文的返回地址。

- **目的端口：**16位，端口指明接收方计算机上的应用程序接口。TCP报头中的源端口号和目的端口号同IP数据报中的源IP与目的IP唯一确定一条TCP连接。

- **序号和确认号：**是TCP可靠传输的关键部分。

- - **序号**，sequence number，保证网络传输数据的顺序性。是本报文段发送的数据组的第一个字节的序号。在TCP传送的流中，每一个字节一个序号。e.g.一个报文段的序号为300，此报文段数据部分共有100字节，则下一个报文段的序号为400。所以序号确保了TCP传输的有序性。
  - **确认号**，acknowledgment number，即ACK，用来确认确实有收到相关封包，内容表示期望收到下一个报文的序列号，用来解决丢包的问题。指明下一个期待收到的字节序号，表明该序号之前的所有数据已经正确无误的收到。确认号只有当ACK标志为1时才有效。比如建立连接时，SYN报文的ACK标志位为0。

- **数据偏移／首部长度：**4bits。由于首部可能含有可选项内容，因此TCP报头的长度是不确定的，报头不包含任何任选字段则长度为20字节，4位首部长度字段所能表示的最大值为1111，转化为10进制为15，15*32/8 = 60，故报头最大长度为60字节。首部长度也叫数据偏移，是因为首部长度实际上指示了数据区在报文段中的起始偏移值。

- **保留：**4bits。为将来定义新的用途保留，现在一般置0。

- **标志位：**CWR、ECN-Echo、URG、ACK、PSH、RST、SYN、FIN，每一个标志位表示一个控制功能。

- - **CWR：**Congestion window reduced，拥塞窗口减少。拥塞窗口减少标志被发送主机设置，用来表明它接收到了设置ECE标志的TCP包。拥塞窗口是被TCP维护的一个内部变量，用来管理发送窗口大小。
  - **ECN-Echo：**显式拥塞提醒回应。当一个IP包的ECN域被路由器设置为11时，接收端而非发送端被通知路径上发生了拥塞。ECN使用TCP头部来告知发送端网络正在经历拥塞，并且告知接收端发送段已经受到了接收端发来的拥塞通告，已经降低了发送速率。
  - **URG：**紧急指针标志，为1时表示紧急指针有效，为0则忽略紧急指针。
  - **ACK：**确认序号标志，为1时表示确认号有效，为0表示报文中不含确认信息，忽略确认号字段。
  - **PSH：**push标志，为1表示是带有push标志的数据，指示接收方在接收到该报文段以后，应尽快将这个报文段交给应用程序，而不是在缓冲区排队。
  - **RST：**重置连接标志，为1时，表示释放连接，重连。用于重置由于主机崩溃或其他原因而出现错误的连接。或者用于拒绝非法的报文段和拒绝连接请求。
  - **SYN：**同步序号，用于建立连接过程，在连接请求中，SYN=1和ACK=0表示该数据段没有使用捎带的确认域，而连接应答捎带一个确认，即SYN=1和ACK=1。
  - **FIN：**finish标志，用于释放连接，为1时表示发送方已经没有数据发送了，即关闭本方数据流。

- **窗口：**占16bits。滑动窗口大小，用来告知发送端接受端的缓存大小，以此控制发送端发送数据的速率，从而达到流量控制。窗口大小是一个16bit字段，因而窗口大小最大为65535。

- **校验和：**占16bits。奇偶校验，此校验和是对整个的 TCP 报文段，包括 TCP 头部和 TCP 数据，以 16 位字进行计算所得。由发送端计算和存储，并由接收端进行验证。

- **紧急指针：**占16bits。只有当 URG 标志置 1 时紧急指针才有效。紧急指针是一个正的偏移量，和顺序号字段中的值相加表示紧急数据最后一个字节的序号。TCP 的紧急方式是发送端向另一端发送紧急数据的一种方式。

- **选项和填充：**最常见的可选字段是最长报文大小，又称为MSS（Maximum Segment Size），每个连接方通常都在通信的第一个报文段（为建立连接而设置SYN标志为1的那个段）中指明这个选项，它表示本端所能接受的最大报文段的长度。选项长度不一定是32位的整数倍，所以要加填充位，即在这个字段中加入额外的零，以保证TCP头是32的整数倍。

- **数据部分：**TCP 报文段中的数据部分是可选的。在一个连接建立和一个连接终止时，双方交换的报文段仅有 TCP 首部。如果一方没有数据要发送，也使用没有任何数据的首部来确认收到的数据。在处理超时的许多情况中，也会发送不带任何数据的报文段。

**2.2 TCP报文结构图示（****一图学会****）**

![1719139711932](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1719139711932.png)

**有同学喜欢表格展示，博主也提供出来啦！**

| **字段**              | **长度** | **含义**                                                     |
| --------------------- | -------- | ------------------------------------------------------------ |
| Source Port           | 16比特   | 源端口，标识哪个应用程序发送。                               |
| Destination Port      | 16比特   | 目的端口，标识哪个应用程序接收。                             |
| Sequence Number       | 32比特   | 序号字段。TCP链接中传输的数据流中每个字节都编上一个序号。序号字段的值指的是本报文段所发送的数据的第一个字节的序号。 |
| Acknowledgment Number | 32比特   | 确认号，是期望收到对方的下一个报文段的数据的第1个字节的序号，即上次已成功接收到的数据字节序号加1。只有ACK标识为1，此字段有效。 |
| Data Offset           | 4比特    | 数据偏移，即首部长度，指出TCP报文段的数据起始处距离TCP报文段的起始处有多远，以32比特（4字节）为计算单位。最多有60字节的首部，若无选项字段，正常为20字节。 |
| Reserved              | 6比特    | 保留，必须填0。                                              |
| URG                   | 1比特    | 紧急指针有效标识。它告诉系统此报文段中有紧急数据，应尽快传送（相当于高优先级的数据）。 |
| ACK                   | 1比特    | 确认序号有效标识。只有当ACK=1时确认号字段才有效。当ACK=0时，确认号无效。 |
| PSH                   | 1比特    | 标识接收方应该尽快将这个报文段交给应用层。接收到PSH  = 1的TCP报文段，应尽快的交付接收应用进程，而不再等待整个缓存都填满了后再向上交付。 |
| RST                   | 1比特    | 重建连接标识。当RST=1时，表明TCP连接中出现严重错误（如由于主机崩溃或其他原因），必须释放连接，然后再重新建立连接。 |
| SYN                   | 1比特    | 同步序号标识，用来发起一个连接。SYN=1表示这是一个连接请求或连接接受请求。 |
| FIN                   | 1比特    | 发端完成发送任务标识。用来释放一个连接。FIN=1表明此报文段的发送端的数据已经发送完毕，并要求释放连接。 |
| Window                | 16比特   | 窗口：TCP的流量控制，窗口起始于确认序号字段指明的值，这个值是接收端正期望接收的字节数。窗口最大为65535字节。 |
| Checksum              | 16比特   | 校验字段，包括TCP首部和TCP数据，是一个强制性的字段，一定是由发端计算和存储，并由收端进行验证。在计算检验和时，要在TCP报文段的前面加上12字节的伪首部。 |
| Urgent Pointer        | 16比特   | 紧急指针，只有当URG标志置1时紧急指针才有效。TCP的紧急方式是发送端向另一端发送紧急数据的一种方式。紧急指针指出在本报文段中紧急数据共有多少个字节（紧急数据放在本报文段数据的最前面）。 |
| Options               | 可变     | 选项字段。TCP协议最初只规定了一种选项，即最长报文段长度（数据字段加上TCP首部），又称为MSS。MSS告诉对方TCP“我的缓存所能接收的报文段的数据字段的最大长度是MSS个字节”。 |
| Padding               | 可变     | 填充字段，用来补位，使整个首部长度是4字节的整数倍。          |
| data                  | 可变     | TCP负载。                                                    |