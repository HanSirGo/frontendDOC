# 网络大师课

# 1 网络分层模型和应用协议

## 1.1 分层模型

### 1.1.1 分层的意义

当遇到一个复杂问题的时候，可以使用分层的思想把问题简单化

比如，你有半杯82年的可乐，想分享给你的朋友王富贵，但你们已经10年没有联系了。要完成这件事，你可能要考虑：

- 我用什么装可乐？

  可能的方案：塑料瓶、玻璃瓶、煤气罐

- 怎么保证可乐始终处于低温？

  可能的方案：保温杯、小冰箱、冰盒

- 如何保证可乐不被运输的人偷喝？

  可能的方案：封条、在上面写「毒药」

- 如何获取王富贵的地址？

  可能的方案：报案失踪、联系私人侦探、联系物流公司的朋友

- 如何运输？

  可能的方案：自行车、汽车、火车、高铁、飞机、火箭

这就形成了一个分层结构

![1720346193030](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1720346193030.png)

从常理出发，我们可以得出以下结论：

- 每层相对独立，只需解决自己的问题
- 每层无须考虑上层的交付，仅需把自己的结果交给下层即可
- 每层有多种方案可供选择，选择不同的方案不会对上下层造成影响
- 每一层会在上一层的基础上增加一些额外信息

### 1.1.2 五层网络模型

网络要解决的问题是：**两个程序之间如何交换数据**。

这是一个非常复杂的问题，因为两个程序有可能出现在不同的设备上。

面对复杂的问题，可以使用分层的方式来简化。

经过不断的演化，网络最终形成了五层模型：

![1720346215448](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1720346215448.png)

### 1.1.3 数据的传输

![1720346234246](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1720346234246.png)

### 1.1.4 四层、五层、七层

![1720346251410](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1720346251410.png)

## 1.2 应用层协议

### 1.2.1 URL

URL（uniform resource locator，统一资源定位符）用于定位网络服务

![1720346262581](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1720346262581.png)

URL是一个固定格式的字符串

![1720346278024](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1720346278024.png)

它表达了：

从网络中==哪台计算机（domain）==中的==哪个程序（port）==寻找==哪个服务（path）==，并注明了获取服务的==具体细节（query）==，以及要用什么样的==协议通信（schema）==

这里面包含了一些细节：

- 当协议是`http`端口为`80`时，端口可以省略
- 当协议是`https`端口为`443`时，端口可以省略
- `schema`、`domain`、`path`是必填的，其他的根据具体的要求填写

### 1.2.2 HTTP

超文本传输协议（Hyper Text Transfer Protocol，*HTTP*）是一个广泛运用于互联网的应用层协议。

99%的情况下，前端开发者接触的都是HTTP协议。

该协议规定了两个方面的内容：

- **传递消息的模式**
- **传递消息的格式**

#### 1.2.2.1 传递消息的模式

![1720346306538](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1720346306538.png)

HTTP使用了一种极为简单的消息传递模式，「请求-响应」模式

发起请求的称之为客户端，接收请求并完成响应的称之为服务器。

「请求-响应」完成后，一次交互结束。

#### 1.2.2.2 传递消息的格式

![1720346332637](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1720346332637.png)

HTTP的消息格式是一种纯文本的格式，文本分为三个部分：

```
请求行
请求头

请求体
```

**具体每一部分写什么内容，要看具体的服务要求**

#### 1.2.2.3 试一试

有非常多的工具可以发送http请求，这里推荐一个非常直观的工具

1. 安装`vscode`插件`REST Clinet

![1720346362563](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1720346362563.png)

1. 新建文件`xxx.http`

2. 编写请求文本

   ```
   POST /api/user/login HTTP/1.1
   Host: study.duyiedu.com
   Content-Type: application/json
   
   {
     "loginId":"admin",
     "loginPwd":"123123"
   }
   ```

3. 发送请求

#### 1.2.2.4 熟悉关键信息

##### 1.2.2.4.1 请求方法

请求行中的第一个单词是请求方法

**在HTTP协议中，请求方法仅有语义的区别**，只是表达了这次请求的「愿望」。

> 关于请求方法的协议原文见 HTTP/1.1规范RFC7231-Chapter4
>
> ![1720346396708](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1720346396708.png)

比如`GET`表达了客户端想要获取一些东西，`POST`表达了客户端想要提交一些东西

常见的请求方法有：

- `GET`：获取
- `POST`：提交
- `PUT`：修改
- `DELETE`：删除

**具体在开发中应该选择什么请求方法，一定是看服务方的要求**

通常情况下：

- 获取数据一般使用`GET`
- 提交数据一般使用`POST`
- 各种静态资源的获取，一般使用`GET`

##### 1.2.2.4.2 请求头 - `Host`

```
Host`标注了`URL`地址中的`Domain + Port
```

示例：

```
Host: study.duyiedu.com
```

##### 1.2.2.4.3 请求头 - `Content-Type`

`Content-Type`标注了附带的请求体是什么格式

比如，请求体的数据为`loginId:admin, loginPwd:123456`，请求体可以用不同的格式发出

```
Content-Type: application/x-www-form-urlencoded

loginId=admin&loginPwd=123123
Content-Type: application/json

{ "loginId": "admin", "loginPwd": "123123" }
Content-Type: multipart/form-data; boundary=aaa

--aaa
Content-Disposition: form-data; name="loginId"

admin
--aaa
Content-Disposition: form-data; name="loginPwd"

123456
--aaa
Content-Disposition: form-data; name="avatar"; filename="small.jpg"
Content-Type: image/jpeg

文件的二进制
--aaa--

```

##### 1.2.2.4.4 响应码

响应码（状态码、消息码）是响应行中的一个数字，后面往往跟上一个对应的单词，用于表达服务器对这个响应的整体「态度」

常见的响应码有：

![1720346433478](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1720346433478.png)

常见的状态码有：

1. 200 OK：一切正常。

2. 301 Moved Permanently：资源已被永久重定向。

   `你的请求我收到了，但是呢，你要的东西不在这个地址了，我已经永远的把它移动到了一个新的地址，麻烦你取请求新的地址，地址我放到了响应头的Location中了`

   > 试试请求：www.douyutv.com

3. 302 Found：资源已被临时重定向。

   `你的请求我收到了，但是呢，你要的东西不在这个地址了，我临时的把它移动到了一个新的地址，麻烦你取请求新的地址，地址我放到了请求头的Location中了`

4. 304 Not Modified：文档内容未被修改。

   `你的请求我收到了，你要的东西跟之前是一样的，没有任何的变化，所以我就不给你结果了，你自己就用以前的吧。啥？你没有缓存以前的内容，关我啥事`

5. 400 Bad Request：语义有误，当前请求无法被服务器理解。

   `你给我发的是个啥啊，我听都听不懂`

6. 403 Forbidden：服务器拒绝执行。

   `你的请求我已收到，但是我就是不给你东西`

7. 404 Not Found：资源不存在。

   `你的请求我收到了，但我没有你要的东西`

8. 500 Internal Server Error：服务器内部错误。

   `你的请求我已收到，但这道题我不会，解不出来，先睡了`

##### 1.2.2.4.5 响应头 - `Content-Type`

`Content-Type`标注了附带的响应体是什么格式

常见的值有：

1. `text/plain`: 普通的纯文本
2. `text/html`：html文档
3. `text/javascript` 或 `application/javascript`：js代码
4. `text/css`：css代码
5. `image/jpeg`：jpg图片
6. `attachment`：附件
7. 其他`MIME`类型

## 1.3 思考

根据这节课学到的知识，思考一个问题：如果不使用浏览器，是否能够完成页面浏览？

# 2 浏览器的通信能力

## 2.1 用户代理

浏览器可以代替用户完成http请求，代替用户解析响应结果，所以我们称之为：

**用户代理 user agent**

在网络层面，对于前端开发者，必须要知道浏览器拥有的两大核心能力：

- 自动发出请求的能力
- 自动解析响应的能力

### 2.1.1 自动发出请求的能力

当一些事情发生的时候，浏览器会代替用户自动发出http请求，常见的包括：

1. **用户在地址栏输入了一个url地址，并按下了回车**

   浏览器会自动解析URL，并发出一个`GET`请求，同时抛弃当前页面。

2. **当用户点击了页面中的a元素**

   浏览器会拿到a元素的href地址，并发出一个`GET`请求，同时抛弃当前页面。

3. **当用户点击了提交按钮<button type="submit">...</button>**

   浏览器会获取按钮所在的`<form>`元素，拿到它的`action`属性地址，同时拿到它`method`属性值，然后把表单中的数据组织到请求体中，发出`指定方法`的请求，同时抛弃当前页面。

   > 这种方式的提交现在越来越少见了

4. **当解析HTML时遇到了<link> <img> <script> <video> <audio>等元素**

   浏览器会拿到对应的地址，发出`GET`请求

5. **当用户点击了刷新**

   浏览器会拿到当前页面的地址，以及当前页面的请求方法，重新发一次请求，同时抛弃当前页面。

> 浏览器在发出请求时，会自动附带一些请求头

==重点来了==

从古至今，浏览器都有一个约定：

**当发送GET请求时，浏览器不会附带请求体**

这个约定深刻的影响着后续的前后端各种应用，现在，几乎所有人都在潜意识中认同了这一点，无论是前端开发人员还是后端开发人员。

由于前后端程序的默认行为，逐步造成了GET和POST的各种差异：

1. 浏览器在发送 GET 请求时，不会附带请求体
2. GET 请求的传递信息量有限，适合传递少量数据；POST 请求的传递信息量是没有限制的，适合传输大量数据。
3. GET 请求只能传递 ASCII 数据，遇到非 ASCII 数据需要进行编码；POST 请求没有限制
4. 大部分 GET 请求传递的数据都附带在 path 参数中，能够通过分享地址完整的重现页面，但同时也暴露了数据，若有敏感数据传递，不应该使用 GET 请求，至少不应该放到 path 中
5. POST 不会被保存到浏览器的历史记录中
6. 刷新页面时，若当前的页面是通过 POST 请求得到的，则浏览器会提示用户是否重新提交。若是 GET 请求得到的页面则没有提示。

### 2.1.2 自动解析响应的能力

浏览器不仅能发送请求，还能够针对服务器的各种响应结果做出不同的自动处理

常见的处理有：

1. **识别响应码**

   浏览器能够自动识别响应码，当出现一些特殊的响应码时浏览器会自动完成处理，比如`301、302`

2. **根据响应结果做不同的处理**

   浏览器能够自动分析响应头中的`Content-Type`，根据不同的值进行不同处理，比如：

3. - `text/plain`: 普通的纯文本，浏览器通常会将响应体原封不动的显示到页面上

   - `text/html`：html文档，浏览器通常会将响应体作为页面进行渲染

   - `text/javascript`或`application/javascript`：js代码，浏览器通常会使用JS执行引擎将它解析执行

   - `text/css`：css代码，浏览器会将它视为样式

   - `image/jpeg`：浏览器会将它视为jpg图片

   - `application/octet-stream`：二进制数据，会触发浏览器下载功能

   - `attachment`：附件，会触发下载功能

     该值和其他值不同，应放到`Content-Disposition`头中。

### 2.1.3 基本流程

> 访问：https://oss.duyiedu.com/test/index.html

![1720346527943](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1720346527943.png)

## 2.2 AJAX

> 浏览器本身就具备网络通信的能力，但在早期，浏览器并没有把这个能力开放给JS。
>
> 最早是微软在IE浏览器中把这一能力向JS开放，让JS可以在代码中实现发送请求，并不会刷新页面，这项技术在2005年被正式命名为AJAX（**A**synchronous **J**avascript **A**nd **X**ML）

AJAX 就是指在web应用程序中异步向服务器发送请求。

它的实现方式有两种，`XMLHttpRequest 简称XHR`和`Fetch`

以下是两者的对比

| 功能点                   | XHR      | Fetch     |
| :----------------------- | :------- | :-------- |
| 基本的请求能力           | ✅        | ✅         |
| 基本的获取响应能力       | ✅        | ✅         |
| 监控请求进度             | ✅        | ❌         |
| 监控响应进度             | ✅        | ✅         |
| Service Worker中是否可用 | ❌        | ✅         |
| 控制cookie的携带         | ❌        | ✅         |
| 控制重定向               | ❌        | ✅         |
| 请求取消                 | ✅        | ✅         |
| 自定义referrer           | ❌        | ✅         |
| 流                       | ❌        | ✅         |
| API风格                  | `Event`  | `Promise` |
| 活跃度                   | 停止更新 | 不断更新  |

## 2.3 实战

### 2.3.1 请求并获取响应数据

请求地址：https://study.duyiedu.com/api/herolist

请求方法：GET

响应类型：application/json

响应结果：王者荣耀英雄数据

### 2.3.2 上传文件并监控进度

#### 2.3.2.1 准备工作：启动本地文件上传服务器

**如果没有安装node**

1. 下载安装node，https://nodejs.org/zh-cn/

2. 打开命令行工具，设置淘宝源

   ```
   npm config set registry https://registry.npm.taobao.org
   ```

**安装依赖**

1. 在命令行进入`upload-server`目录
2. 运行`npm i`

**启动服务器**

1. 在命令行进入`upload-server`目录
2. 运行`npm start`

#### 2.3.2.2 上传接口

请求路径：`/upload/single`

请求方法：`POST`

消息格式：`multipart/form-data`

字段名称：`avatar`

允许的后缀名：`['.jpg', '.jpeg', '.bmp', '.webp', '.gif', '.png']`

最大尺寸：`1M`

响应格式：`JSON`

响应结果示例：

```
// 成功
{
  "data": "文件的访问地址"
}
// 失败：后缀名不符号要求
{
  "errCode": 1,
  "errMsg": "后缀名不符合要求"
}
// 失败：文件过大
{
  "errCode": 2,
  "errMsg": "文件过大"
}
```

### 2.3.3 ChatGPT

#### 2.3.3.1 准备工作：启动本地服务器

> 已安装好node，以及设置好了npm的淘宝源

**安装依赖**

1. 在命令行进入`chat-server`目录
2. 运行`npm i`

**启动服务器**

1. 在命令行进入`chat-server`目录
2. 运行`npm run dev`

#### 2.3.3.2 聊天接口

请求路径：`/chat`

请求方法：`POST`

请求消息格式：`application/json`

请求体格式：

```
// 清除当前的聊天上下文
// 清除后，服务器不再记录之前的聊天内容，后续的聊天将使用新的上下文
{
  "clear": true
}

// 发送消息
{
  "content": "我要你扮演海绵宝宝的魔法海螺壳"
}
```

响应格式：`纯文本`

```
好的，我现在开始扮演海绵宝宝的魔法海螺壳。我可以说出各种魔法语言和帮助海绵宝宝和派大星解决问题。让我们开始冒险吧！噢呵呵呵呵！
```

注意：响应比较耗时，服务器会流式的将文本发送到客户端，为了提高用户体验，客户端最好流式的接收消息。

### 2.3.4 实战代码

#### 2.3.4.1 王者荣耀英雄列表（使用fetch）

```
# http构造
GET /api/herolist HTTP/1.1
Host: study.duyiedu.com
```

index.css

```css
* {
  padding: 0;
  margin: 0;
  box-sizing: border-box;
}
ul {
  list-style: none;
}
a {
  text-decoration: none;
  color: inherit;
}

body {
  background: #ecedf2;
}
.container {
  width: 1140px;
  margin: 1em auto;
}

.search {
  margin-bottom: 30px;
  display: flex;
  justify-content: space-between;
  height: 100px;
  line-height: 50px;
}
.title {
  background: #5488d5;
  color: #fff;
  width: 80px;
  text-align: center;
  border-radius: 10px 0 0 10px;
}
.types {
  flex: 1 0 auto;
  color: #666;
  background: #fff;
  font-size: 14px;
}

.type-list {
  display: flex;
  padding-left: 20px;
}

.radio {
  margin-right: 30px;
  padding-left: 30px;
  position: relative;
  cursor: pointer;
}
.radio::before {
  content: '';
  position: absolute;
  width: 20px;
  height: 20px;
  left: 0;
  top: 50%;
  transform: translateY(-50%);
  border: 1px solid #ccc;
  border-radius: 50%;
}
.radio::after {
  content: '';
  position: absolute;
  width: 14px;
  height: 14px;
  left: 4px;
  top: 50%;
  transform: translateY(-50%) scale(0);
  background: #5f89cf;
  border-radius: 50%;
  transition: 0.25s;
}
.radio.checked::after {
  transform: translateY(-50%) scale(1);
}
.keyword {
  background: #fff;
  padding-right: 30px;
}
.input {
  margin-top: 50px;
  border: 1px solid #ccc;
  height: 40px;
  padding-right: 40px;
  border-radius: 5px;
  width: 300px;
  position: relative;
}
.input input {
  height: 100%;
  display: block;
  width: 100%;
  outline: none;
  border: none;
  border-radius: 5px;
  padding-left: 1em;
  font-size: 12px;
}
.input::before {
  content: '';
  position: absolute;
  width: 40px;
  height: 100%;
  right: 0;
  background: url('./search_icon.png') no-repeat center;
  border-left: 1px solid #ccc;
  height: 20px;
  top: 50%;
  transform: translateY(-50%);
}

.list {
  display: grid;
  grid-template-columns: repeat(10, 1fr);
  justify-items: center;
  text-align: center;
  font-size: 14px;
  row-gap: 20px;
  color: #333;
}
.list img {
  width: 77px;
  height: 77px;
  display: block;
  margin-bottom: 5px;
  border: 2px solid #5f89cf;
  border-radius: 10px 0 10px 0;
}
```

index.html

```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link rel="stylesheet" href="./index.css" />
  </head>
  <body>
    <div class="container">
      <ul class="list">
        <li>
          <a
            href="https://pvp.qq.com/web201605/herodetail/544.shtml"
            target="_blank"
          >
            <img
              src="https://game.gtimg.cn/images/yxzj/img201606/heroimg/544/544.jpg"
              alt=""
            />
            <span>赵怀真</span>
          </a>
        </li>
        <li>
          <a
            href="https://pvp.qq.com/web201605/herodetail/544.shtml"
            target="_blank"
          >
            <img
              src="https://game.gtimg.cn/images/yxzj/img201606/heroimg/544/544.jpg"
              alt=""
            />
            <span>赵怀真</span>
          </a>
        </li>
        <li>
          <a
            href="https://pvp.qq.com/web201605/herodetail/544.shtml"
            target="_blank"
          >
            <img
              src="https://game.gtimg.cn/images/yxzj/img201606/heroimg/544/544.jpg"
              alt=""
            />
            <span>赵怀真</span>
          </a>
        </li>
        <li>
          <a
            href="https://pvp.qq.com/web201605/herodetail/544.shtml"
            target="_blank"
          >
            <img
              src="https://game.gtimg.cn/images/yxzj/img201606/heroimg/544/544.jpg"
              alt=""
            />
            <span>赵怀真</span>
          </a>
        </li>
        <li>
          <a
            href="https://pvp.qq.com/web201605/herodetail/544.shtml"
            target="_blank"
          >
            <img
              src="https://game.gtimg.cn/images/yxzj/img201606/heroimg/544/544.jpg"
              alt=""
            />
            <span>赵怀真</span>
          </a>
        </li>
        <li>
          <a
            href="https://pvp.qq.com/web201605/herodetail/544.shtml"
            target="_blank"
          >
            <img
              src="https://game.gtimg.cn/images/yxzj/img201606/heroimg/544/544.jpg"
              alt=""
            />
            <span>赵怀真</span>
          </a>
        </li>
        <li>
          <a
            href="https://pvp.qq.com/web201605/herodetail/544.shtml"
            target="_blank"
          >
            <img
              src="https://game.gtimg.cn/images/yxzj/img201606/heroimg/544/544.jpg"
              alt=""
            />
            <span>赵怀真</span>
          </a>
        </li>
        <li>
          <a
            href="https://pvp.qq.com/web201605/herodetail/544.shtml"
            target="_blank"
          >
            <img
              src="https://game.gtimg.cn/images/yxzj/img201606/heroimg/544/544.jpg"
              alt=""
            />
            <span>赵怀真</span>
          </a>
        </li>
        <li>
          <a
            href="https://pvp.qq.com/web201605/herodetail/544.shtml"
            target="_blank"
          >
            <img
              src="https://game.gtimg.cn/images/yxzj/img201606/heroimg/544/544.jpg"
              alt=""
            />
            <span>赵怀真</span>
          </a>
        </li>
        <li>
          <a
            href="https://pvp.qq.com/web201605/herodetail/544.shtml"
            target="_blank"
          >
            <img
              src="https://game.gtimg.cn/images/yxzj/img201606/heroimg/544/544.jpg"
              alt=""
            />
            <span>赵怀真</span>
          </a>
        </li>
        <li>
          <a
            href="https://pvp.qq.com/web201605/herodetail/544.shtml"
            target="_blank"
          >
            <img
              src="https://game.gtimg.cn/images/yxzj/img201606/heroimg/544/544.jpg"
              alt=""
            />
            <span>赵怀真</span>
          </a>
        </li>
        <li>
          <a
            href="https://pvp.qq.com/web201605/herodetail/544.shtml"
            target="_blank"
          >
            <img
              src="https://game.gtimg.cn/images/yxzj/img201606/heroimg/544/544.jpg"
              alt=""
            />
            <span>赵怀真</span>
          </a>
        </li>
        <li>
          <a
            href="https://pvp.qq.com/web201605/herodetail/544.shtml"
            target="_blank"
          >
            <img
              src="https://game.gtimg.cn/images/yxzj/img201606/heroimg/544/544.jpg"
              alt=""
            />
            <span>赵怀真</span>
          </a>
        </li>
        <li>
          <a
            href="https://pvp.qq.com/web201605/herodetail/544.shtml"
            target="_blank"
          >
            <img
              src="https://game.gtimg.cn/images/yxzj/img201606/heroimg/544/544.jpg"
              alt=""
            />
            <span>赵怀真</span>
          </a>
        </li>
        <li>
          <a
            href="https://pvp.qq.com/web201605/herodetail/544.shtml"
            target="_blank"
          >
            <img
              src="https://game.gtimg.cn/images/yxzj/img201606/heroimg/544/544.jpg"
              alt=""
            />
            <span>赵怀真</span>
          </a>
        </li>
        <li>
          <a
            href="https://pvp.qq.com/web201605/herodetail/544.shtml"
            target="_blank"
          >
            <img
              src="https://game.gtimg.cn/images/yxzj/img201606/heroimg/544/544.jpg"
              alt=""
            />
            <span>赵怀真</span>
          </a>
        </li>
        <li>
          <a
            href="https://pvp.qq.com/web201605/herodetail/544.shtml"
            target="_blank"
          >
            <img
              src="https://game.gtimg.cn/images/yxzj/img201606/heroimg/544/544.jpg"
              alt=""
            />
            <span>赵怀真</span>
          </a>
        </li>
        <li>
          <a
            href="https://pvp.qq.com/web201605/herodetail/544.shtml"
            target="_blank"
          >
            <img
              src="https://game.gtimg.cn/images/yxzj/img201606/heroimg/544/544.jpg"
              alt=""
            />
            <span>赵怀真</span>
          </a>
        </li>
        <li>
          <a
            href="https://pvp.qq.com/web201605/herodetail/544.shtml"
            target="_blank"
          >
            <img
              src="https://game.gtimg.cn/images/yxzj/img201606/heroimg/544/544.jpg"
              alt=""
            />
            <span>赵怀真</span>
          </a>
        </li>
        <li>
          <a
            href="https://pvp.qq.com/web201605/herodetail/544.shtml"
            target="_blank"
          >
            <img
              src="https://game.gtimg.cn/images/yxzj/img201606/heroimg/544/544.jpg"
              alt=""
            />
            <span>赵怀真</span>
          </a>
        </li>
      </ul>
    </div>
    <script src="./index.js"></script>
  </body>
</html>
```

index.js

```js
// 拿英雄数据 fetch
async function loadHeroes() {
  const resp = await fetch('https://study.duyiedu.com/api/herolist');
  // 当响应头完整的被浏览器读取到后，该Promise完成
  // console.log('头部信息已经到达客户端');
  // console.log(resp.headers.get('Content-Type'));
  // console.log(resp.status);
  // console.log(resp.statusText);
  const body = await resp.json();
  document.querySelector('.list').innerHTML = body.data
    .map(
      (h) => `<li>
  <a
    href="https://pvp.qq.com/web201605/herodetail/${h.ename}.shtml"
    target="_blank"
  >
    <img
      src="https://game.gtimg.cn/images/yxzj/img201606/heroimg/${h.ename}/${h.ename}.jpg"
      alt=""
    />
    <span>${h.cname}</span>
  </a>
</li>`
    )
    .join('');
}

loadHeroes();
```

#### 2.3.4.2 图片上传并显示进度（使用XHR）

```
# http构造
POST /upload/single HTTP/1.1
Host: myserver.com:9527
Content-Type: multipart/form-data; boundary=aaa

--aaa
Content-Disposition: form-data; name="avatar"; filename="small.jpg"
Content-Type: image/jpeg

< ./1.png
--aaa--
```

index.css

```css
.upload {
  --border-color: #dcdfe6;
  --font-color: #8c939d;
  --primary-color: #409eff;
  --danger-color: #eb685e;
}

.upload * {
  box-sizing: border-box;
}

.upload {
  width: 150px;
  height: 150px;
  position: relative;
  overflow: hidden;
  border-radius: 5px;
}

.upload .preview {
  object-fit: contain;
  z-index: 1;
}

.upload > * {
  position: absolute;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
}

.upload > div {
  display: none;
  z-index: 2;
}

.upload.select .upload-select {
  display: block;
}
.upload.select .preview {
  display: none;
}

.upload.progress .upload-progress {
  display: block;
}

.upload.result .upload-result {
  display: block;
}

.upload-select {
  border-radius: inherit;
  border: 1px dashed var(--border-color);
  cursor: pointer;
}
.upload-select::before,
.upload-select::after {
  content: '';
  position: absolute;
  left: 50%;
  top: 50%;
  width: 30px;
  height: 3px;
  border-radius: 3px;
  background: var(--font-color);
  transform: translate(-50%, -50%);
}
.upload-select::after {
  transform: translate(-50%, -50%) rotate(90deg);
}
.upload-select input {
  opacity: 0;
  display: block;
  position: absolute;
  inset: 0;
}
.upload-select:hover {
  border-color: var(--primary-color);
}

.upload-progress {
  background: #00000080;
}

.progress-bar {
  position: absolute;
  width: 90%;
  height: 3px;
  background: #fff;
  border-radius: 3px;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
  color: #fff;
  font-size: 12px;
}
.progress-bar::before {
  counter-reset: progress var(--percent);
  content: counter(progress) '%';
  position: absolute;
  left: 50%;
  top: -20px;
  transform: translateX(-50%);
}
.progress-bar::after {
  content: '';
  position: absolute;
  left: 0;
  border-radius: inherit;
  width: calc(1% * var(--percent));
  height: 100%;
  background: var(--primary-color);
}
.upload-progress::after {
  content: '文件上传中...';
  position: absolute;
  left: 50%;
  top: 50%;
  transform: translate(-50%, 5px);
  white-space: nowrap;
  opacity: 0.8;
  color: #fff;
  font-size: 12px;
}
.upload button {
  border: none;
  outline: none;
  background: none;
  color: inherit;
  font-size: inherit;
  cursor: pointer;
  user-select: none;
}
.progress-bar button {
  left: 50%;
  position: absolute;
  top: 25px;
  transform: translateX(-50%);
}
.progress-bar button:hover {
  color: var(--danger-color);
}

.upload-result {
  border: 1px dashed var(--border-color);
  border-radius: inherit;
  overflow: hidden;
}

.upload-result button {
  width: 30px;
  height: 20px;
  background: var(--font-color);
  position: absolute;
  right: 0;
  top: 0;
  border-radius: 2px;
  color: #fff;
}
.upload-result button:hover {
  background: var(--danger-color);
}
```

index.html

```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>文件上传demo</title>
    <link rel="stylesheet" href="./css/index.css" />
  </head>
  <body>
    <div class="upload select">
      <div class="upload-select">
        <input type="file" />
      </div>
      <div class="upload-progress" style="--percent: 20">
        <div class="progress-bar">
          <button>取消</button>
        </div>
      </div>
      <div class="upload-result">
        <button>X</button>
      </div>
      <img src="./files/small.jpg" alt="" class="preview" />
    </div>
    <script src="./js/index.js"></script>
  </body>
</html>
```

index.js

```js
const $ = document.querySelector.bind(document);
const doms = {
  img: $('.preview'),
  container: $('.upload'),
  select: $('.upload-select'),
  selectFile: $('.upload-select input'),
  progress: $('.upload-progress'),
  cancelBtn: $('.upload-progress button'),
  delBtn: $('.upload-result button'),
};

function showArea(areaName) {
  doms.container.className = `upload ${areaName}`;
}

function setProgress(value) {
  doms.progress.style.setProperty('--percent', value);
}

doms.selectFile.onchange = (e) => {
  const file = e.target.files[0];
  // 显示预览图
  const reader = new FileReader();
  reader.onload = (e) => {
    // 读取完成
    doms.img.src = e.target.result;
    showArea('progress');
    upload(file);
  };
  reader.readAsDataURL(file); // 将文件数据读取为 DataURL（base64编码）
};

function upload(file) {
  setProgress(0);
  // XHR
  const xhr = new XMLHttpRequest();
  xhr.open('POST', 'http://myserver.com:9527/upload/single'); // 配置请求
  xhr.upload.onprogress = (e) => {
    const percent = Math.floor((e.loaded / e.total) * 100);
    setProgress(percent);
  };
  xhr.onload = () => {
    showArea('result');
  };
  // xhr.abort(); // 中止请求
  const form = new FormData(); // 生成multipart/form-data格式的请求体
  form.append('avatar', file);
  xhr.send(form);
}
```

#### 2.3.4.3

```
# http构造
POST /chat HTTP/1.1
Host: myserver.com:7010
Content-Type: application/json

{
  "clear": true
}
```

index.css

```css
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}
html {
  scroll-behavior: smooth;
}

::-webkit-scrollbar {
  height: 1rem;
  width: 0.5rem;
}

::-webkit-scrollbar-thumb {
  --tw-border-opacity: 1;
  background-color: rgba(217, 217, 227, 0.8);
  border-color: rgba(255, 255, 255, var(--tw-border-opacity));
  border-radius: 9999px;
  border-width: 1px;
}
::-webkit-scrollbar-thumb {
  --tw-bg-opacity: 1;
  background-color: rgba(86, 88, 105, var(--tw-bg-opacity));
}
body {
  background: #343541;
  -webkit-text-size-adjust: 100%;
  font-family: Söhne, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto,
    Ubuntu, Cantarell, Noto Sans, sans-serif, Helvetica Neue, Arial,
    Apple Color Emoji, Segoe UI Emoji, Segoe UI Symbol, Noto Color Emoji;
  line-height: 2;
  tab-size: 4;
}
body::after {
  content: '';
  position: fixed;
  width: 100%;
  height: 20%;
  background: linear-gradient(to top, #00000080, transparent);
  left: 0;
  bottom: 0;
  z-index: 10;
}
.block {
  padding: 12px;
  border-bottom: 1px solid rgba(32, 33, 35, 0.5);
}
.user {
  background: #343541;
  color: #e2e5e9;
}
.robot {
  background: #40414e;
  color: #d1d5db;
}
.container {
  max-width: 768px;
  margin: 0 auto;
  padding: 12px 0;
  display: flex;
  column-gap: 20px;
  align-items: start;
}
.avatar {
  background: #765bbd;
  width: 30px;
  height: 30px;
  border-radius: 3px;
  flex-shrink: 0;
  display: flex;
  justify-content: center;
  align-items: center;
  overflow: hidden;
  white-space: nowrap;
}
.avatar img {
  width: 22px;
  height: 22px;
}
.robot .avatar {
  background: #000;
}
.title {
  font-size: 14px;
  text-align: center;
}
.main::after {
  content: '';
  display: block;
  height: 100px;
}
.send {
  position: fixed;
  z-index: 100;
  bottom: 30px;
  width: 100%;
  max-width: 768px;
  background: rgb(64, 65, 79);
  border-radius: 6px;
  border: 1px solid rgba(32, 33, 35, 0.5);
  box-shadow: rgba(0, 0, 0, 0) 0px 0px 0px 0px, rgba(0, 0, 0, 0) 0px 0px 0px 0px,
    rgba(0, 0, 0, 0.1) 0px 0px 15px 0px;
  left: 50%;
  transform: translateX(-50%);
  padding: 10px;
  padding-right: 30px;
}
.send button {
  color: rgb(142, 142, 160);
  border: none;
  outline: none;
  width: 20px;
  height: 20px;
  display: flex;
  background: transparent;
  justify-content: center;
  align-items: center;
  border-radius: 2px;
  user-select: none;
  cursor: pointer;
  position: absolute;
  right: 15px;
  bottom: 15px;
}
.send button:hover {
  background: #000;
}
.send textarea {
  display: block;
  width: 100%;
  resize: none;
  outline: none;
  border: none;
  font-size: 16px;
  line-height: 2;
  margin-right: 30px;
  color: #fff;
  max-height: 200px;
  background: transparent;
}
.send .spin {
  display: none;
}
.send.waiting .submit {
  display: none;
}
.send.waiting .spin {
  display: flex;
  column-gap: 3px;
  background: none;
  cursor: wait;
}
.markdown-body {
  background: inherit;
}
.send.waiting .spin span {
  width: 4px;
  height: 4px;
  background: rgba(255, 255, 255, 0.4);
  border-radius: 50%;
  animation: toggle 0.9s infinite;
  opacity: 0;
}
.send.waiting .spin span:nth-child(2) {
  animation-delay: 0.3s;
}
.send.waiting .spin span:nth-child(3) {
  animation-delay: 0.6s;
}

@keyframes toggle {
  30% {
    opacity: 1;
  }
}

.typing .content {
  position: relative;
}
.typing .content::after {
  content: '';
  position: absolute;
  width: 10px;
  height: 16px;
  background: #d5d9da;
  animation: toggle 0.6s infinite;
  opacity: 0;
  left: var(--x);
  top: var(--y);
}
```

index.html

```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ChatGPT-OpenAI</title>
    <link
      rel="shortcut icon"
      href="./asset/favicon-32x32.png"
      type="image/x-icon"
    />
    <link
      href="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/github-markdown-css/5.1.0/github-markdown-dark.min.css"
      type="text/css"
      rel="stylesheet"
    />
    <link
      href="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/highlight.js/11.4.0/styles/github-dark.min.css"
      type="text/css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="./index.css" />
  </head>
  <body>
    <div class="main">
      <div class="robot block">
        <div class="title">🐶🐶🐶🐶🐶</div>
      </div>
    </div>
    <form class="send">
      <textarea rows="1"></textarea>
      <button class="submit" type="submit">
        <svg
          stroke="currentColor"
          fill="none"
          stroke-width="2"
          viewBox="0 0 24 24"
          stroke-linecap="round"
          stroke-linejoin="round"
          class="h-4 w-4 mr-1"
          height="1em"
          width="1em"
          xmlns="http://www.w3.org/2000/svg"
        >
          <line x1="22" y1="2" x2="11" y2="13"></line>
          <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
        </svg>
      </button>
      <button class="spin" type="button">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </form>

    <script src="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/marked/4.0.2/marked.min.js"></script>
    <div class="markdown-body" id="content"></div>
    <script
      src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/highlight.js/11.4.0/highlight.min.js"
      type="application/javascript"
    ></script>
    <script src="./js/index.js"></script>
    <script src="./js/chat.js"></script>
  </body>
</html>
```

index.js

```js
var { createUserContent, createRobotContent } = (() => {
  marked.setOptions({
    highlight: function (code, lang) {
      if (lang && hljs.getLanguage(lang)) {
        return hljs.highlight(code, { language: lang }).value;
      }
      return hljs.highlightAuto(code).value;
    },
  });
  const txt = document.querySelector('.send textarea');
  txt.addEventListener('input', () => {
    txt.style.height = 'auto';
    txt.style.height = txt.scrollHeight + 'px';
  });
  const main = document.querySelector('.main');

  function _createUserContent(username, content) {
    const dom = document.createElement('div');
    dom.className = 'user block';
    dom.innerHTML = ` <div class="container">
    <div class="avatar">
      ${username}
    </div>
    <div class="content markdown-body">
      ${_normalizeContent(content)}
    </div>
  </div>`;
    const hitBottom = isBottom();
    main.appendChild(dom);
    if (hitBottom) {
      document.documentElement.scrollTo(0, 1000000);
    }
  }

  function _normalizeContent(content) {
    const html = marked.parse(content, {
      breaks: true,
      gfm: true,
    });
    return html;
  }
  const textarea = document.querySelector('.send textarea');
  function createUserContent(username) {
    const content = textarea.value.trim();
    _createUserContent(username, content);
    textarea.value = '';
    textarea.style.height = 'auto';
  }
  function _getLastTextNode(dom) {
    const children = dom.childNodes;
    for (let i = children.length - 1; i >= 0; i--) {
      const node = children[i];
      if (node.nodeType === Node.TEXT_NODE && /\S/.test(node.nodeValue)) {
        node.nodeValue = node.nodeValue.replace(/\s+$/, '');
        return node;
      } else if (node.nodeType === Node.ELEMENT_NODE) {
        const last = _getLastTextNode(node);
        if (last) {
          return last;
        }
      }
    }
    return null;
  }
  function _updateCursor(dom) {
    const contentDom = dom;
    const lastText = _getLastTextNode(contentDom);
    const textNode = document.createTextNode('\u200b');
    if (lastText) {
      lastText.parentElement.appendChild(textNode);
    } else {
      contentDom.appendChild(textNode);
    }
    const domRect = contentDom.getBoundingClientRect();
    const range = document.createRange();
    range.setStart(textNode, 0);
    range.setEnd(textNode, 0);
    const rect = range.getBoundingClientRect();
    const x = rect.left - domRect.left;
    const y = rect.top - domRect.top;
    dom.style.setProperty('--x', `${x}px`);
    dom.style.setProperty('--y', `${y}px`);
    textNode.remove();
  }

  function isBottom() {
    return (
      Math.abs(
        document.documentElement.scrollTop +
          document.documentElement.clientHeight -
          document.documentElement.scrollHeight
      ) < 20
    );
  }

  function createRobotContent() {
    const dom = document.createElement('div');
    dom.className = 'robot block typing';
    dom.innerHTML = ` <div class="container">
    <div class="avatar">
    <img src="./asset/gpt-avatar.svg" alt="" />
    </div>
    <div class="content markdown-body" style="--x: -1000px; --y: 0px"></div>
  </div>`;
    const contentDom = dom.querySelector('.content');
    let content = '';
    main.appendChild(dom);
    _updateCursor(contentDom);
    const form = document.querySelector('.send');
    form.classList.add('waiting');
    function append(text) {
      content += text;
      const html = _normalizeContent(content);
      const hitBottom = isBottom();

      contentDom.innerHTML = html;
      if (hitBottom) {
        document.documentElement.scrollTo(0, 1000000);
      }
      _updateCursor(contentDom);
    }

    return {
      append,
      over() {
        dom.classList.remove('typing');
        form.classList.remove('waiting');
      },
    };
  }

  return {
    createUserContent,
    createRobotContent,
    isBottom,
  };
})();
```

chat.js

```js
// 清空聊天记录
fetch('http://myserver.com:7010/chat', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
  },
  body: JSON.stringify({
    clear: true,
  }),
});

const form = document.querySelector('.send');
const textarea = document.querySelector('.send textarea');
const username = '袁';
textarea.onkeydown = (e) => {
  if (e.key === 'Enter' && !e.ctrlKey && !e.shiftKey) {
    e.preventDefault();
    form.dispatchEvent(new Event('submit'));
  }
};

form.onsubmit = async (e) => {
  e.preventDefault();
  const content = textarea.value;
  createUserContent(username);
  const robot = createRobotContent();
  // 请求服务器
  const resp = await fetch('http://myserver.com:7010/chat', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      content,
    }),
  });
  const reader = resp.body.getReader();
  const decoder = new TextDecoder();
  while (1) {
    const { done, value } = await reader.read();
    if (done) {
      break;
    }
    const text = decoder.decode(value);
    robot.append(text);
  }
  robot.over();
};
```

# 3 跨域问题及解决方案

## 3.1 同源策略及跨域问题

**同源策略**是一套浏览器**安全机制**，当一个**源**的文档和脚本，与另一个**源**的资源进行通信时，同源策略就会对这个通信做出不同程度的限制。

简单来说，同源策略对 **同源资源** **放行**，对 **异源资源** **限制**

因此限制造成的开发问题，称之为**跨域（异源）问题**

### 3.1.1 同源和异源

```
源(origin) = 协议 + 域名 + 端口
```

例如:

```
https://study.duyiedu.com/api/movie`的源为`https://study.duyiedu.com
http://localhost:7001/index.html`的源为`http://localhost:7001
```

两个URL地址的源**完全相同**，则称之为**同源**，否则称之为**异源（跨域）**

![1720346826196](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1720346826196.png)

### 3.1.2 跨域出现的场景

跨域可能出现在三种场景：

- **网络通信**

  a元素的跳转；加载css、js、图片等；AJAX等等

- JS API

  `window.open`、`window.parent`、`iframe.contentWindow`等等

- 存储

  `WebStorage`、`IndexedDB`等等

对于不同的跨域场景，以及每个场景中不同的跨域方式，同源策略都有不同的限制。

本文重点讨论**网络通信**中`AJAX`的跨域问题

### 3.1.3 网络中的跨域

当浏览器运行页面后，会发出很多的网络请求，例如CSS、JS、图片、AJAX等等

请求页面的源称之为**页面源**，在该页面中发出的请求称之为**目标源**。

当页面源和目标源一致时，则为**同源请求**，否则为**异源请求（跨域请求）**

![1720346875103](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1720346875103.png)

### 3.1.3 浏览器如何限制异源请求？

浏览器出于多方面的考量，制定了非常繁杂的规则来限制各种跨域请求，但总体的原则非常简单：

- 对标签发出的跨域请求轻微限制
- 对AJAX发出的跨域请求**严厉限制**

![1720346910836](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1720346910836.png)

## 3.2 解决方案

### 3.2.1 CORS

CORS（Cross-Origin Resource Sharing）是最正统的跨域解决方案，同时也是浏览器推荐的解决方案。

CORS是一套规则，用于帮助浏览器判断是否校验通过。

![1720346955929](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1720346955929.png)

CORS的基本理念是：

- 只要服务器明确表示**允许**，则校验**通过**
- 服务器明确拒绝或没有表示，则校验不通过

**所以，使用CORS解决跨域，必须要保证服务器是「自己人」**

#### 3.2.1.1 请求分类

CORS将请求分为两类：==简单请求==和==预检请求==。

对不同种类的请求它的规则有所区别。

所以要理解CORS，首先要理解它是如何划分请求的。

##### 3.2.1.1.1 简单请求

> 完整判定逻辑：https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS#simple_requests

简单来说，只要全部满足下列条件，就是简单请求：

- 请求方法是`GET`、`POST`、`HEAD`之一

- 头部字段满足CORS安全规范，详见 W3C

  > 浏览器默认自带的头部字段都是满足安全规范的，只要开发者不改动和新增头部，就不会打破此条规则

- 如果有`Content-Type`，必须是下列值中的一个

- - `text/plain`
  - `multipart/form-data`
  - `application/x-www-form-urlencoded`

##### 3.2.1.1.2 预检请求(preflight)

只要不是简单请求，均为预检请求

##### 3.2.1.1.3 练习

```
// 下面的跨域请求哪些是简单请求，哪些是预检请求

// 1
fetch('https://douyin.com');

// 2
fetch('https://douyin.com', {
  headers: {
    a: 1,
  },
});

// 3
fetch('https://douyin.com', {
  method: 'POST',
  body: JSON.stringify({ a: 1, b: 2 }),
});

// 4
fetch('https://douyin.com', {
  method: 'POST',
  headers: {
    'content-type': 'application/json',
  },
  body: JSON.stringify({ a: 1, b: 2 }),
});
```

#### 3.2.1.2 对简单请求的验证

![图片](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)image-20230112204546583

#### 3.2.1.3 对预检请求的验证

1. 发送预检请求

![1720346995548](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1720346995548.png)

1. 发送真实请求（和简单请求一致）

#### 3.2.1.4 细节1 - 关于cookie

默认情况下，ajax的跨域请求并不会附带cookie，这样一来，某些需要权限的操作就无法进行

不过可以通过简单的配置就可以实现附带cookie

```js
// xhr
var xhr = new XMLHttpRequest();
xhr.withCredentials = true;

// fetch api
fetch(url, {
  credentials: "include"
})
```

这样一来，该跨域的ajax请求就是一个*附带身份凭证的请求*

当一个请求需要附带cookie时，无论它是简单请求，还是预检请求，都会在请求头中添加`cookie`字段

而服务器响应时，需要明确告知客户端：服务器允许这样的凭据

告知的方式也非常的简单，只需要在响应头中添加：`Access-Control-Allow-Credentials: true`即可

对于一个附带身份凭证的请求，若服务器没有明确告知，浏览器仍然视为跨域被拒绝。

另外要特别注意的是：**对于附带身份凭证的请求，服务器不得设置 Access-Control-Allow-Origin 的值为\***。这就是为什么不推荐使用*的原因

#### 3.2.1.5 细节2 - 关于跨域获取响应头

在跨域访问时，JS只能拿到一些最基本的响应头，如：Cache-Control、Content-Language、Content-Type、Expires、Last-Modified、Pragma，如果要访问其他头，则需要服务器设置本响应头。

`Access-Control-Expose-Headers`头让服务器把允许浏览器访问的头放入白名单，例如：

```
Access-Control-Expose-Headers: authorization, a, b
```

这样JS就能够访问指定的响应头了。

#### 3.2.1.6 案例

服务器端

```js
const express = require('express');
const bodyParser = require('body-parser');
const cors = require('cors');
const app = express();
app.use(cors());
app.use(bodyParser.json());

// jsonp
app.get('/jsonp', (req, res) => {
  const cbname = req.query.callback || 'callback';
  const data = {
    msg: '来自服务器的消息',
  };
  res.set('content-type', 'application/javascript');
  // res.end(`alert(1)`);
  res.end(`${cbname}(${JSON.stringify(data)})`);
});

// proxy
app.get('/hero', async (req, res) => {
  const axios = require('axios');
  const resp = await axios.get('https://pvp.qq.com/web201605/js/herolist.json');

  // 使用CORS解决对代理服务器的跨域
  res.header('access-control-allow-origin', '*');
  res.send(resp.data);
});

const PORT = 9527;

app.listen(PORT, () => {
  console.log(`server start on port ${PORT}`);
});
```

客户端

index.html

```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <script>
      (async () => {
        const resp = await fetch('https://study.duyiedu.com/api/user/login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            loginId: 'admin1',
            loginPwd: '123123',
          }),
        });
        const auth = resp.headers.get('Authorization');
        console.log(auth);
      })();
    </script>
  </body>
</html>
```

demo.html

```
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <script></script>
  </body>
</html>
```

api.js

```js
function login(loginId, loginPwd) {
  return request('post', 'https://study.duyiedu.com/api/user/login', {
    body: {
      loginId,
      loginPwd,
    },
  }).then((resp) => resp.body.data);
}

function chat(content) {
  return request('post', 'https://study.duyiedu.com/api/chat', {
    body: {
      content,
    },
  }).then((resp) => resp.body.data);
}
```

request.js

```
window.request = (() => {
  const TOKEN_KEY = '__token__';

  const request = async (method, url, options = {}) => {
    options.headers = options.headers || {};

    // 格式化options
    if (options.body && typeof options.body === 'object') {
      options.body = JSON.stringify(options.body);
      options.headers['content-type'] = 'application/json';
    }

    // 是否携带token
    const token = localStorage.getItem(TOKEN_KEY);
    if (token) {
      // 向请求头中加入内容
      options.headers.authorization = `Bearer ${token}`;
    }

    const resp = await fetch(url, {
      ...options,
      method: method.toUpperCase(),
    });
    const headers = Object.fromEntries(resp.headers.entries());

    // 检查头中的token
    if (headers.authorization) {
      localStorage.setItem(TOKEN_KEY, headers.authorization);
    }

    const body = await resp.json();
    return {
      headers,
      body,
    };
  };
  return request;
})();
```

### 3.2.2 JSONP

在很久很久以前...并没有CORS方案

![1720347463973](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1720347463973.png)

在那个年代，古人靠着非凡的智慧来解决这一问题

![1720347489027](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1720347489027.png)

虽然可以解决问题，但JSONP有着明显的缺陷：

- 仅能使用GET请求

- 容易产生安全隐患

  > 恶意攻击者可能利用`callback=恶意函数`的方式实现`XSS`攻击

- 容易被非法站点恶意调用

**因此，除非是某些特殊的原因，否则永远不应该使用JSONP**

#### 3.2.2.1 案例

服务器端

```js
const express = require('express');
const bodyParser = require('body-parser');
const cors = require('cors');
const app = express();
app.use(cors());
app.use(bodyParser.json());

// jsonp
app.get('/jsonp', (req, res) => {
  const cbname = req.query.callback || 'callback';
  const data = {
    msg: '来自服务器的消息',
  };
  res.set('content-type', 'application/javascript');
  // res.end(`alert(1)`);
  res.end(`${cbname}(${JSON.stringify(data)})`);
});

// proxy
app.get('/hero', async (req, res) => {
  const axios = require('axios');
  const resp = await axios.get('https://pvp.qq.com/web201605/js/herolist.json');

  // 使用CORS解决对代理服务器的跨域
  res.header('access-control-allow-origin', '*');
  res.send(resp.data);
});

const PORT = 9527;

app.listen(PORT, () => {
  console.log(`server start on port ${PORT}`);
});
```

客户端

```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <script>
      function request(url) {
        return new Promise((resolve) => {
          // 准备一个全局函数
          // jsonp_
          const callbackName = `jsonp_${
            Math.random().toString(36).substring(2) + Date.now()
          }`;
          window[callbackName] = function (resp) {
            script.remove();
            delete window[callbackName];
            resolve(resp);
          };
          const script = document.createElement('script');
          script.src = url + '?callback=' + callbackName;
          document.body.appendChild(script);
        });
      }

      request('http://localhost:9527/jsonp').then((resp) => {
        console.log('ok', resp);
      });
    </script>
  </body>
</html>
```

### 3.2.3 代理

CORS和JSONP均要求服务器是「自己人」

那如果不是呢？

![1720347544739](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1720347544739.png)

那就找一个中间人（代理）

![1720347566333](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1720347566333.png)

比如，前端小王想要请求获取王者荣耀英雄数据，但直接请求腾讯服务器会造成跨域

![1720347581285](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1720347581285.png)

由于腾讯服务器不是「自己人」，小王决定用代理解决

![1720347599561](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1720347599561.png)

### 3.2.4 如何选择

最重要的，是要保持**生产环境和开发环境一致**

下面是一张决策图

![1720347617847](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1720347617847.png)

具体的几种场景

![1720347635976](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1720347635976.png)

![1720347646543](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1720347646543.png)