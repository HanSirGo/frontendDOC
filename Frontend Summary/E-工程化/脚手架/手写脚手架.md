### ç¬¬ä¸€ç§
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/direct/7cf064869de94e559284a7a077e3f020.png)
#### package.json
> zr  æ˜¯è¿™ä¸ªè„šæ‰‹æ¶çš„åˆ«åï¼Œå¯ä»¥ä½¿ç”¨zr æ¥åˆ›å»ºé¡¹ç›® ä¾‹å¦‚ï¼šzr create projectname

```javascript
{
  "name": "zr-cli",
  "version": "1.0.0",
  "description": "jiaoshoujia",
  "main": "index.js",
  "bin": {
    "zr": "./bin/cli.js"
  },
  "scripts": {
    "test": "echo \"Error: no test specified\" && exit 1"
  },
  "author": "",
  "license": "ISC",
  "dependencies": {
    "axios": "^1.5.0",
    "chalk": "^4.1.2",
    "commander": "^8.3.0",
    "download-git-repo": "^3.0.2",
    "figlet": "^1.2.0",
    "fs-extra": "^9.1.0",
    "inquirer": "^6.5.2",
    "leven": "^3.1.0",
    "ora": "^5.4.1"
  }
}

```
#### bin/cli.js
```javascript
#! /usr/bin/env node

const leven = require('leven')
// å‘½ä»¤è¡Œç¾åŒ–å·¥å…·
const chalk = require('chalk')
// è‡ªå®šä¹‰å‘½ä»¤è¡ŒæŒ‡ä»¤
const program = require('commander')
// figlet ç»˜åˆ¶logo
const figlet = require('figlet')
program
	.version(`zr ${require('../package.json').version}`)
	.usage('<command> [options]')
// è¾“å…¥ zr --helpæ—¶ æ‰“å°logo
program.on('--help', () => {
	console.log('\r\n' + figlet.textSync('zr_cli', {
		font: 'Ghost',
		width: 80,
		whitespaceBreak: true
	}))
})
// åˆ›å»ºå‘½ä»¤
program
	.command('create <name>')
	.description('create a new project')
	.action((name, options) => {
		console.log(`project name is ${chalk.cyan(name)}`)
		require('../lib/index')(name, options)
	})

program.on('command:*', (operands) => {
	console.error(`error: unknown command '${operands[0]}'`);
});
program.parse(process.argv)
```
#### lib/create.js

```javascript
// ç”¨æˆ·é€‰æ‹©æ¨¡æ¿ ä¸‹è½½æ¨¡æ¿
const { getTemplateList } = require('./http')
const ora = require('ora')
const inquirer = require('inquirer')
const util = require('util')
const path = require('path')
const fs = require('fs')
const chalk = require('chalk')
const downloadGitRepo = require('download-git-repo')

/**
 * @description: æ·»åŠ  åˆ›å»ºçš„åŠ è½½åŠ¨ç”»
 * @return {*}
 */
async function createLoaging(fn, message, ...args) {
	// ä½¿ç”¨ ora åˆå§‹åŒ–ï¼Œä¼ å…¥æç¤ºä¿¡æ¯ message
	const spinner = ora(message)
	// åŠ è½½åŠ¨ç”» å¼€å§‹
	spinner.start()
	try {
		// è°ƒç”¨  fn
		const result = await fn(...args)
		// åŠ è½½æˆåŠŸ
		spinner.succeed()
		return result
	} catch (e) {
		// åŠ è½½å¤±è´¥
		spinner.fail('åŠ è½½å¤±è´¥...')
	}
}


/**
 * @description: é¡¹ç›®åˆ›å»ºé€»è¾‘
 * @return {*}
 */
class Generator {
	constructor(name, targetAir) {
		// é¡¹ç›®åå­—ï¼Œä¹Ÿæ˜¯æ–‡ä»¶å
		this.name = name
		// åˆ›å»ºä½ç½® ç›®å½•
		this.targetAir = targetAir
		// promiseåŒ–
		this.downloadGitRepo = util.promisify(downloadGitRepo)
	}

	/**
	 * @description: è·å–ç”¨æˆ·é€‰æ‹©çš„æ¨¡æ¿(ä»è¿œç¨‹è·å–)
	 * @return {*} è¿”å›ç”¨æˆ·é€‰æ‹©çš„æ¨¡æ¿ä¿¡æ¯
	 */
	async getTemplate() {

		/** ä»è¿œç¨‹è·å–æ¨¡æ¿åˆ—è¡¨ */
		const templatelist = await getTemplateList()
		/**æ²¡è·å–åˆ° */
		if (templatelist) return
		/**è·å–æ¨¡æ¿åˆ—è¡¨çš„æ¯ä¸€é¡¹name */
		const templates = templatelist.map(item => item.name)
		/**ç”¨æˆ·é€‰æ‹©è‡ªå·±è¦ä¸‹è½½çš„æ¨¡æ¿ */
		const { template } = await inquirer.prompt({
			name: 'template',
			type: 'list',
			choices: templates,
			message: 'è¯·é€‰æ‹©æ¨¡æ¿'
		})
		return template
	}

	/**
	 * @description: è·å–ç”¨æˆ·é€‰æ‹©çš„æ¨¡æ¿(æ ¹æ®è¿œç¨‹åˆ›å»ºçš„æ¨¡æ¿ï¼Œè‡ªå·±åˆ›å»º)
	 * @return {*} è¿”å›ç”¨æˆ·é€‰æ‹©çš„æ¨¡æ¿ä¿¡æ¯
	 */
	async getLocalTemplate() {

		const questions = [
			{
				type: 'list',
				name: 'template',
				message: 'æ¨¡æ¿ç±»å‹',
				choices: [
					{ name: 'vite project', value: 'master' },
					{ name: 'qiankun vite vue3', value: 'qiankun-vite-vue3' },
					{ name: 'qiankun webpack vue3', value: 'qiankun-webpack-vue3' }
				]
			}
		]
		const { template } = await inquirer.prompt(questions)
		return template
	}

	/**
	 * @description: ä¸‹è½½æ¨¡æ¿
	 * @return {*}
	 */
	async download(template) {
		// ä¸‹è½½åœ°å€
		const requireUrl = `direct:http://gitlab.safewx.cn/yindongsheng/vite-template/-/archive/${template}/vite-template-${template}.zip`
		await createLoaging(this.downloadGitRepo, 'æ¨¡æ¿ç”Ÿæˆ...', requireUrl, path.resolve(process.cwd(), this.targetAir))
		console.log("ğŸš€ ~ file: create.js:99 ~ Generator ~ download ~ requireUrl:", requireUrl)
		/**package.json */
		const packageFile = path.join(process.cwd(), this.name + '/package.json')
		const packages = require(packageFile)
		packages.name = this.name
	}

	/**
	 * @description: åˆ›å»ºç”¨æˆ·é€‰æ‹©çš„æ¨¡æ¿
	 * @return {*} 
	 */
	async create() {
		// const template = await this.getTemplate()
		const template = await this.getLocalTemplate()
		console.log(`ç”¨æˆ·é€‰æ‹©æ¨¡æ¿ ${template}`)
		await this.download(template)
		console.log(`\r\nSuccessfully created project ${chalk.cyan(this.name)}`)
		console.log(`\r\n  ${chalk.cyan('cd ' + this.name)}`)
		console.log(`  ${chalk.cyan('npm install')}\r\n`)
		console.log(`  ${chalk.cyan('npm run serve')}\r\n`)
	}
}
module.exports = Generator
```
#### lib/http.js
```javascript
/**
 * @description: å¤„ç†æ¨¡æ¿ç­‰ä¿¡æ¯çš„è·å–
 * @return {*} 
 */

const axios = require('axios')
axios.interceptors.response.use(res => {
    return res.data
})
/**
 * @description: è·å–æ¨¡æ¿åˆ—è¡¨
 * @return {*}
 */
async function getTemplateList() {
    return axios.get('http://gitlab.safewx.cn/yindongsheng/vite-template/')
}
module.exports = {
    getTemplateList
}
```
#### lib/index.js

```javascript
const path = require('path')
// ç”¨æ¥åˆ¤æ–­æ–‡ä»¶æ˜¯å¦å·²å­˜åœ¨
const fs = require('fs-extra')
// è¯¢é—®ç”¨æˆ·é—®é¢˜è·å–åˆ›å»ºä¿¡æ¯
const inquirer = require('inquirer')
const Generator = require('./create')
// åˆ›å»ºå‘½ä»¤
module.exports = async function (name, options) {
	console.log("ğŸš€ ~ file: create.js:2 ~ options:", options)
	console.log("ğŸš€ ~ file: create.js:2 ~ name:", name)
	// å½“å‰å‘½ä»¤è¡Œé€‰æ‹©çš„ç›®å½•
	const cwd = process.cwd()
	// éœ€è¦åˆ›å»ºçš„ç›®å½•åœ°å€
	const targetAir = path.join(cwd, name)
	// ç›®å½•æ˜¯å¦å·²å­˜åœ¨
	if (fs.existsSync(targetAir)) {
		// è¯¢é—®ç”¨æˆ·ï¼šæ˜¯å¦å¼ºåˆ¶åˆ›å»ºï¼Œè¦†ç›–åŸæ–‡ä»¶
		let { action } = await inquirer.prompt([
			{
				name: 'action',
				type: 'list',
				message: 'æ–‡ä»¶å·²å­˜åœ¨ï¼Œæ˜¯å¦è¦†ç›–',
				choices: [
					{
						name: 'Yes',
						value: true
					},
					{
						name: 'No',
						value: false
					}
				]
			}
		])
		// å–æ¶ˆåˆ›å»º
		if (!action) return
		// åˆ›å»º
		// å†™ä¸€ä¸ªè¦†ç›–åŠ è½½åŠ¨ç”»
		console.log('\r\nRemoving....')
		await fs.remove(targetAir)
	}
	// ç›´æ¥åˆ›å»º
	// å†™ä¸€ä¸ªåˆ›å»ºåŠ è½½åŠ¨ç”»
	const generator = new Generator(name, targetAir)
	// å¼€å§‹åˆ›å»º
	generator.create()
}
```
### ç¬¬äºŒç§
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/direct/709cc1dee8334e5b907d410fa73b74fd.png)
#### package.json
```javascript
{
  "name": "template-cli",
  "version": "1.0.0",
  "description": "",
  "main": "index.js",
  "bin": "bin/www",
  "scripts": {
    "test": "echo \"Error: no test specified\" && exit 1"
  },
  "keywords": [],
  "author": "",
  "license": "ISC",
  "dependencies": {
    "axios": "^0.20.0",
    "commander": "^6.1.0",
    "download-git-repo": "^3.0.2",
    "handlebars": "^4.7.6",
    "inquirer": "^7.3.3",
    "metalsmith": "^2.3.0",
    "ora": "^5.1.0",
    "rimraf": "^3.0.2"
  }
}

```
#### bin/www
ç¡®å®æ²¡åç¼€
```javascript
#!/usr/bin/env node
require('../src/index.js');
```
#### src/create.js

```javascript
const path = require('path')
const fs = require('fs')
// å°†nodejsæ–¹æ³•çš„æ ‡å‡†å†™æ³•method(xxx, (error) => {}),è½¬æ¢æˆpromiseå†™æ³•ã€‚
const { promisify } = require('util')
let downloadGitRepo = require('download-git-repo')
const Metalsmith = require('metalsmith')
const Handlebars = require('handlebars')
const rm = require('rimraf').sync
const ora = require('ora')
const question = require('./questions')
const axios = require('axios')

function download(repo, dest) {
  return promisify(downloadGitRepo)(repo, dest)
}

function isExistFolder(file) {
  return fs.existsSync(file)
}

function generator(source, dest, metadata = {}) {
  return new Promise((resolve, reject) => {
    Metalsmith(process.cwd())
      .metadata(metadata)
      .source(source)
      .destination(dest)
      .clean(true)
      .use((files, metalsmith, callback) => {
        const data = metalsmith.metadata()
        Object.keys(files).forEach((file) => {
          // files[file].contents æ˜¯ä¸ªæ–‡ä»¶æµ Bufferç±»å‹
          const context = files[file].contents.toString()
          // const str = Handlebars.compile(context)(data);
          files[file].contents = Buffer.from(context)
        })
        callback()
      })
      .build((err) => {
        rm(source)
        if (!err) {
          resolve()
        } else {
          reject(err)
        }
      })
  })
}

function loading(fn, message) {
  return async (...args) => {
    const spinner = ora(message)
    spinner.start()
    const data = await fn(...args)
    spinner.succeed()
    return data
  }
}

async function create(args) {
  const answers = await question()
  const folderName = args[0]
  const folderPath = path.resolve(process.cwd(), folderName)
  const TEMPDIR = path.resolve(process.cwd(), '.TEMPLATE')
  const state = isExistFolder(folderPath)
  if (!state) {
    const { templateType } = answers
    await loading(download, 'æ¨¡æ¿ä¸‹è½½ä¸­...')(
      `direct:http://gitlab.safewx.cn/yindongsheng/vite-template/-/archive/${templateType}/vite-template-${templateType}.zip`,
      TEMPDIR,
      function (err) {
        console.log(err)
      }
    )
    await loading(generator, 'é¡¹ç›®ç”Ÿæˆä¸­...')(TEMPDIR, folderName, answers)
  } else {
    console.error('å½“å‰ç›®å½•ä¸‹å·²å­˜åœ¨', folderName)
  }
}

module.exports = { create }

```
#### src/index.js

```javascript
const path = require('path');
const program = require('commander');
const { create } = require('./create');
const { name, version } = require('../package.json');

program.name(name).version(version);
program
    .command('create')
    .description('create an application.')
    .action(() => {
        const rest = process.argv.slice(3);
        if (rest) {
            create(rest);
        }
    });
program.on('command:*', (operands) => {
    console.error(`error: unknown command '${operands[0]}'`);
});
// process æ˜¯nodeçš„å…¨å±€å¯¹è±¡ï¼Œä¸éœ€è¦requireå¼•å…¥
program.parse(process.argv); // æ”¾åœ¨æœ«å°¾
```
#### src/questions.js

```javascript
const inquirer = require('inquirer')
// const {exec} = require('child_process')
// exec('git remote add temp-repo http://gitlab.safewx.cn/yindongsheng/vite-template.git && git branch',(err,stdout,stderr)=>{
//   if(err){
//     throw err
//   }
//   console.log(stdout);
// })
const questions = [
  {
    type: 'list',
    name: 'templateType',
    message: 'æ¨¡æ¿ç±»å‹',
    choices: [
      { name: 'vite project', value: 'master' },
      { name: 'qiankun vite vue3', value: 'qiankun-vite-vue3' },
      { name: 'qiankun webpack vue3', value: 'qiankun-webpack-vue3' }
    ]
  }
]

module.exports = function () {
  return inquirer.prompt(questions)
}

```
// TODO æœ‰ä¸€ä¸ªè§†é¢‘ä¸­æœ‰,å…ˆåœ¨æ¨¡æ¿package.jsonä¸­ {{name}} ...
### ä¿®æ”¹æ¨¡æ¿çš„package.jsonæ–‡ä»¶

